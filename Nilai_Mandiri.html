<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RUBRIK ASESMEN MANDIRI</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root{
  --bg: #fff5fc; --accent: #000000; --muted: #334e68; --card: #ffffff;
  --input: #f7f9fc; --nav-bg: #ffcefd; --shadow-light: rgba(0,0,0,0.05);
  --primary:#b30077; --deep-blue:#003366; --light-blue:#e9f2ff;
}
*{box-sizing:border-box; transition: all 0.2s ease-out;}
body{font-family:"Segoe UI",sans-serif;margin:0;background:var(--bg);color:var(--muted);font-size:13px}

header {
  position: fixed; top: 0; left: 0; right: 0; height: 44px;
  background: linear-gradient(90deg,#ff00b3,var(--primary));
  color: #fff; z-index: 1000; display: flex; align-items: center; justify-content: center;
}
header h1{margin:0;font-weight:700;font-size:15px;text-align:center}
.home-btn {
            position: absolute; left: 15px; color: white; text-decoration: none; 
            font-size: 18px; display: flex; align-items: center;
        }
.identity-bar {
  position: fixed; top: 44px; left: 0; right: 0;
  background: var(--nav-bg); padding: 6px 8px;
  z-index: 900; border-bottom: 1px solid #dcdfe4;
}
.identity-inner{ max-width:980px; margin:0 auto; display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
.identity-left{display:flex; flex-direction:column; gap:6px; flex:1 1 auto;}

.identity-toplabel-container{ background:var(--light-blue); border-radius:6px; padding:4px 8px; text-align:center; border:1px solid #c6d6f5; }
.identity-toplabel{font-weight:700; font-size:13px; color:var(--deep-blue);}

.identity-form-container{ background:#fff; border:1px solid #d3dae7; border-radius:8px; padding:6px 8px; }
.identity-row { display: grid; grid-template-columns: 3fr 80px; gap: 8px; margin-bottom: 6px; align-items: end; }
.identity-field { display: flex; flex-direction: column; gap: 2px; position: relative; }

label{font-weight:700; font-size:11px; color:var(--muted); white-space: nowrap;}

.custom-select-trigger {
  width: 100%; min-height: 32px; padding: 6px 8px; border-radius: 5px; border: 1px solid #c9d6e4;
  background: var(--input); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
}

.input-token {
  width: 100%; height: 32px; padding: 6px 8px; border-radius: 5px; border: 1px solid #c9d6e4;
  background: #fff8e1; font-size: 16px; text-align: center; font-weight: bold;
}

.btn-mulai {
  width: 100%; background: var(--primary); color: #fff; border: none; border-radius: 6px; 
  padding: 10px; font-weight: 700; cursor: pointer; margin-top: 1px;
}

.floating-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #c9d6e4; 
  border-radius: 5px; margin-top: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
  z-index: 1100; max-height: 200px; overflow-y: auto; display: none;
}
.floating-dropdown div { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f1f1; font-size: 13px;}
.show { display: block; }

.score-panel{
  display:flex; flex-direction:column; align-items:center; gap:2px;
  padding:5px 6px; border-radius:6px; background:#fff; border:1px solid rgba(179,0,119,0.12); min-width:85px;
}
.score-pill{
  display:block; padding:2px 0; width:55px; text-align:center; border-radius:4px; 
  background:#fff5fc; border:1px solid rgba(179,0,119,0.08); font-weight:700; color:var(--primary); font-size:14px;
}
.score-label{font-size:10px; color:#444; font-weight:700; text-transform:uppercase;}

.main { max-width: 980px; margin: 0 auto; padding-top: 220px; padding-bottom: 80px; padding-left: 10px; padding-right: 10px; } 

#questions, #btnNext { display: none; }

.question-card {
  background: var(--card); border-left: 4px solid var(--accent); padding: 15px; border-radius: 8px; 
  margin-bottom: 15px; box-shadow: 0 4px 8px var(--shadow-light); word-wrap: break-word; overflow-wrap: break-word;
}

.q-text { font-size: 14px; margin: 0 0 12px 0; font-weight: 700; color: var(--accent); line-height: 1.5; white-space: normal; } 
.opt { 
  display: flex; align-items: flex-start; gap: 10px; padding: 12px; border-radius: 6px; 
  background: var(--input); border: 1px solid #e0e8f0; font-size: 13px; cursor: pointer; 
  margin-bottom: 8px; white-space: normal; line-height: 1.4; 
}
.opt input { margin-top: 3px; flex-shrink: 0; }
.opt span { flex: 1; word-break: break-word; overflow-wrap: break-word; }

.opt-correct { background: #e8f5e9 !important; border-color: #2e7d32 !important; color: #1b5e20 !important; font-weight: bold; }
.opt-wrong { background: #ffebee !important; border-color: #c62828 !important; color: #b71c1c !important; font-weight: bold; }
.question-card.locked { border-left: 5px solid var(--primary); background-color: #fcfcfc; pointer-events: none; }

.fixed-send{position:fixed; left:0; right:0; bottom:0; background:linear-gradient(90deg, #ff00d4, #b300a4); padding:10px; z-index:950;}
.btn-send{background:#fff; color:var(--accent); padding:10px 15px; border-radius:6px; border:none; font-weight:700; cursor:pointer;}

@media (max-width:480px){ .main{padding-top: 300px;} }
</style>
</head>
<body>

<header>
  <a href="https://andes-web.github.io/mpsmobile/" class="home-btn">
    <i class="fas fa-home"></i>
  </a>
  <h1>ASESMEN KARAKTER MANDIRI</h1>
</header>

<div class="identity-bar">
  <div class="identity-inner">
    <div class="identity-left">
      <div class="identity-toplabel-container"><div class="identity-toplabel">Lengkapi Identitas Keanggotaan</div></div>
      <div class="identity-form-container">
        <div class="identity-row">
          <div class="identity-field">
            <label>Unit</label>
            <div id="unit-trigger" class="custom-select-trigger">Pilih Unit</div>
            <div id="unit-dropdown" class="floating-dropdown"></div>
          </div>
          <div class="identity-field">
            <label>Token</label>
            <input type="text" id="input-token" class="input-token" placeholder="***">
          </div>
        </div>
        <div class="identity-row">
          <div class="identity-field">
            <label>Nama</label>
            <div id="nama-trigger" class="custom-select-trigger">Pilih Peserta</div>
            <div id="nama-dropdown" class="floating-dropdown"></div>
          </div>
          <div class="identity-field">
            <label>Panca Waluya</label>
            <div id="sesi-trigger" class="custom-select-trigger" style="justify-content:center">Cageur</div>
            <div id="sesi-dropdown" class="floating-dropdown">
              <div data-val="Cageur">Cageur</div><div data-val="Bageur">Bageur</div>
              <div data-val="Bener">Bener</div><div data-val="Pinter">Pinter</div>
              <div data-val="Singer">Singer</div>
            </div>
          </div>
        </div>
      </div>
      <button id="btnVerify" class="btn-mulai">MULAI ASESMEN</button>
    </div>
    <div class="score-panel">
      <div><div class="score-label">Cag</div><div class="score-pill" id="score-cag">0</div></div>
      <div><div class="score-label">Bag</div><div class="score-pill" id="score-bag">0</div></div>
      <div><div class="score-label">Ben</div><div class="score-pill" id="score-ben">0</div></div>
      <div><div class="score-label">Pin</div><div class="score-pill" id="score-pin">0</div></div>
      <div><div class="score-label">Sin</div><div class="score-pill" id="score-sin">0</div></div>
    </div>
  </div>
</div>

<main class="main"><div id="questions"></div></main>

<div class="fixed-send">
  <div style="max-width:980px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
    <p style="color:#fff; margin:0">Â© 2025 Andes | MPS System</p>
    <button id="btnNext" class="btn-send">SIMPAN DATA</button>
  </div>
</div>

<script>
// GANTI DENGAN URL WEB APP ANDA
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec";
let RAW_DATA = [], SEL_UNIT = "", SEL_SESI = "Cageur", SEL_NAMA = "", TOKEN_VALID = false, userAnswers = {};

const QUEST_DATA = {
    "Cageur": [
        { q: "Saat latihan fisik intensif, Anda merasakan nyeri dada yang tidak biasa namun ingin tetap terlihat kuat di depan junior. Bagaimana Anda bersikap?", o: ["Mengabaikan rasa sakit dan terus lari sampai sesi selesai", "Berhenti sejenak secara diam-diam tanpa melapor instruktur", "Mengajak teman lain untuk ikut berhenti agar tidak sendiri", "Melapor kepada medis mengenai kondisi fisik secara jujur", "Meminum obat pereda nyeri tanpa mengetahui dosis yang pas"] },
        { q: "Instruktur memberikan instruksi dengan suara yang sangat keras dan mengintimidasi. Bagaimana kondisi mental Anda merespon hal ini?", o: ["Merasa takut dan ingin segera pulang karena tidak nyaman", "Tetap tenang mendengarkan instruksi tanpa terbawa emosi", "Membalas dengan teriakan sebagai bentuk protes lapangan", "Menangis di dalam barisan karena merasa sangat tertekan", "Mengabaikan instruksi tersebut karena dianggap kurang sopan"] },
        { q: "Malam sebelum hari H upacara, Anda sulit tidur karena rasa cemas yang tinggi. Apa tindakan yang Anda ambil?", o: ["Begadang sampai pagi hari sambil bermain HP di asrama", "Mengonsumsi obat tidur agar dapat segera terlelap cepat", "Keluar dari asrama untuk mencari udara segar tanpa izin", "Memaksa teman untuk tetap bangun menemani Anda mengobrol", "Melakukan relaksasi dan memastikan tubuh tetap istihat"] },
        { q: "Anda melihat teman satu unit pingsan saat upacara berlangsung. Posisi Anda berada tepat di belakangnya. Apa respon Anda?", o: ["Langsung keluar barisan untuk menolongnya secara spontan", "Tetap tegak di posisi dan membiarkan petugas menangani", "Berteriak memanggil bantuan sambil tetap dalam barisan", "Menertawakannya karena dianggap memiliki fisik yang lemah", "Pura-pura tidak tahu agar fokus tugas tidak terganggu"] },
        { q: "Setelah 3 jam latihan tanpa henti, Anda merasa sangat lapar dan lemas. Apa yang Anda lakukan?", o: ["Mencuri waktu untuk makan saat instruktur sedang lengah", "Sengaja menjatuhkan diri agar diistirahatkan lebih awal", "Bertahan dengan fokus penuh sampai waktu istirahat tiba", "Mengeluh sangat keras agar segera didengar oleh pelatih", "Meninggalkan barisan tanpa izin untuk mencari area kantin"] }
    ],
    "Bageur": [
        { q: "Jatah snack/makan siang teman Anda ternyata tertukar atau hilang. Kebetulan Anda memiliki makanan tambahan. Tindakan Anda?", o: ["Memakan semuanya sendiri karena itu adalah hak milik Anda", "Memberikan makanan tambahan Anda kepadanya dengan ikhlas", "Menertawakannya karena dia tidak menjaga makanan sendiri", "Menyuruhnya meminta-minta kepada anggota dari unit lain", "Melaporkan kejadian tersebut agar semua anggota dihukum"] },
        { q: "Seorang junior melakukan kesalahan gerakan berkali-kali sehingga seluruh unit dihukum push-up. Bagaimana sikap Anda terhadap junior tersebut?", o: ["Membentaknya secara keras setelah latihan sesi selesai", "Menyuruhnya mengundurkan diri saja dari anggota unit ini", "Melarangnya ikut makan siang bersama dengan anggota unit", "Mendekati dan mengajarkan gerakan yang benar dengan sabar", "Menyindirnya di media sosial kelompok sebagai rasa kesal"] },
        { q: "Saat sedang istirahat, Anda melihat ada sampah berserakan yang bukan milik Anda. Apa yang Anda lakukan?", o: ["Mengambil dan membuangnya ke tempat sampah demi kenyamanan", "Membiarkannya saja karena bukan Anda yang membuangnya", "Menyuruh petugas kebersihan untuk datang membersihkannya", "Memfoto sampah tersebut dan mengeluh di grup koordinasi", "Menunggu instruksi dari ketua unit untuk membuang sampah"] },
        { q: "Seorang teman tampak sangat grogi dan gemetar sebelum naik ke podium. Bagaimana Anda berinteraksi dengannya?", o: ["Menambah beban pikirannya dengan menceritakan risiko gagal", "Mengabaikannya agar tidak ikut tertular rasa grogi itu", "Menyuruhnya digantikan oleh orang lain saja untuk tampil", "Menertawakan kegugupannya di depan semua teman-teman unit", "Memberikan kata penguatan dan menepuk pundaknya suportif"] },
        { q: "Unit lain sedang kesulitan membawa perlengkapan tenda mereka. Padahal unit Anda sudah selesai. Tindakan Anda?", o: ["Langsung beristirahat karena tugas unit Anda sudah selesai", "Menonton mereka sambil memberikan banyak komentar negatif", "Menawarkan bantuan tenaga untuk meringankan beban mereka", "Memfoto kesulitan mereka sebagai bahan candaan di kelompok", "Segera pergi tidur agar tidak perlu membantu unit lainnya"] }
    ],
    "Bener": [
        { q: "Anda menemukan dompet milik pelatih tertinggal di area istirahat dalam keadaan terbuka. Apa yang Anda lakukan?", o: ["Mengambil uang di dalamnya untuk operasional harian unit", "Menitipkannya kepada orang asing agar segera disampaikan", "Diam saja dan meninggalkannya begitu saja di tempat lama", "Membuka isinya untuk mengetahui data pribadi milik pelatih", "Segera mengantarkan kepada pelatih tanpa menyentuh isinya"] },
        { q: "Anda melakukan kesalahan kecil saat langkah tegap yang mungkin tidak disadari juri. Bagaimana laporan Anda pada pelatih?", o: ["Mengatakan penampilan sempurna tanpa ada cacat sedikitpun", "Mengakui kesalahan tersebut dengan jujur untuk evaluasi", "Menyalahkan sepatu yang kurang nyaman sebagai alasan utama", "Menyalahkan teman samping yang dianggap salah langkah dulu", "Berbohong kepada pelatih bahwa juri yang salah menilai itu"] },
        { q: "Aturan unit melarang membawa HP selama masa karantina/latihan, namun banyak teman yang melanggar secara sembunyi. Sikap Anda?", o: ["Ikut membawa HP karena teman yang lain juga membawanya", "Membawa HP tetapi tidak pernah digunakan di depan umum", "Meminjam HP milik teman yang melanggar aturan tersebut", "Tetap mematuhi aturan dan tidak membawa HP sesuai janji", "Melaporkan semua teman agar semua mendapat hukuman berat"] },
        { q: "Pelatih memberikan kunci gudang logistik kepada Anda. Teman Anda mengajak untuk mengambil satu kaos tambahan secara diam-diam. Respon Anda?", o: ["Menolak dengan tegas dan menjelaskan tanggung jawab kunci", "Mengambilnya karena stok di gudang masih tersedia banyak", "Mengambilkan untuk teman tapi Anda sendiri tidak mengambil", "Membiarkan teman mengambil sendiri agar Anda tidak salah", "Menceritakan hal tersebut kepada orang lain sebagai rahasia"] },
        { q: "Waktu kumpul yang ditentukan adalah pukul 05.00 pagi. Anda bangun pukul 04.55. Apa yang Anda lakukan?", o: ["Berangkat apa adanya tanpa mandi agar tidak telat kumpul", "Datang terlambat dan mencari alasan yang masuk akal saja", "Datang secepat mungkin dan siap menerima hukuman pelatih", "Pura-pura sakit agar tidak perlu datang pada latihan itu", "Masuk barisan dari arah belakang agar tidak terlihat telat"] }
    ],
    "Pinter": [
        { q: "Terjadi perubahan rute pawai secara mendadak oleh panitia di lapangan. Sebagai komandan, bagaimana Anda bertindak?", o: ["Protes keras kepada panitia karena sudah merusak latihan", "Merasa sangat bingung dan berhenti di tengah jalan raya", "Segera analisis rute baru dan berikan instruksi transisi", "Menyuruh pasukan lari secepat mungkin tanpa aturan baku", "Menunggu instruksi pelatih yang sedang berada sangat jauh"] },
        { q: "Unit Anda tidak memiliki biaya untuk menyewa pelatih profesional. Apa solusi yang Anda tawarkan?", o: ["Membubarkan unit karena tidak ada pelatih yang membimbing", "Menagih iuran sangat tinggi kepada seluruh anggota unit", "Meminta bantuan dana kepada pihak sekolah secara paksa", "Hanya melakukan latihan fisik tanpa ada materi teknis baru", "Mempelajari materi lewat video dan praktik mandiri bersama"] },
        { q: "Saat sedang presentasi materi kepaskibraan, ada audiens yang memberikan pertanyaan sangat sulit. Bagaimana Anda menjawab?", o: ["Mengarang jawaban agar tidak terlihat bodoh di depan umum", "Menjawab data yang diketahui dan berjanji akan riset lagi", "Marah karena pertanyaan tersebut dianggap ingin menjatuhkan", "Menyuruh teman lainnya saja yang menjawab pertanyaan itu", "Diam membisu dan mengalihkan pembicaraan ke topik lainnya"] },
        { q: "Sepatu boot salah satu anggota rusak total tepat 10 menit sebelum tampil. Tindakan cerdas Anda?", o: ["Menangis di tempat karena penampilan pasti akan dibatalkan", "Menyuruh anggota tersebut untuk tidak ikut tampil ke depan", "Menyalahkan anggota tersebut karena tidak cek alat dahulu", "Mencari solusi cepat seperti memakai lakban atau pinjaman", "Mencari toko sepatu terdekat padahal waktu tidak mencukupi"] },
        { q: "Anda harus menghafal 30 variasi formasi dalam satu malam. Metode apa yang Anda gunakan?", o: ["Memetakan pola gerakan dan memahami logika perpindahannya", "Mencoba menghafal semuanya sekaligus tanpa waktu istihat", "Menyerah dan memutuskan mengikuti gerakan teman saja besok", "Minum kopi berlebihan agar mata tetap melek sampai pagi", "Meminta instruktur untuk membatalkan variasi formasi itu"] }
    ],
    "Singer": [
        { q: "Melihat tali tiang bendera sedikit melilit saat upacara sedang berlangsung. Anda bukan petugas pengibar, namun berada paling dekat. Tindakan Anda?", o: ["Hanya menonton dan berharap tali tersebut tidak macet total", "Secara tenang dan sigap membantu membenarkan posisi tali", "Berteriak memberi tahu petugas pengibar tentang kondisi tali", "Tertawa saat bendera benar-benar macet di tengah tiang itu", "Merekam kejadian tersebut dengan HP untuk konten media unit"] },
        { q: "Gudang perlengkapan tampak berantakan setelah kegiatan selesai. Semua orang sudah lelah. Apa yang Anda lakukan?", o: ["Tanpa diperintah mulai merapikan perlengkapan dengan cepat", "Langsung pergi karena ingin segera beristirahat di asrama", "Hanya merapikan barang milik pribadi Anda saja di gudang", "Menyalahkan orang terakhir yang menggunakan gudang tersebut", "Menunggu instruksi dari koordinator logistik untuk merapikan"] },
        { q: "Instruktur sedang sibuk menangani administrasi, sementara pasukan belum mulai latihan. Sebagai senior, apa tindakan Anda?", o: ["Ikut bersantai menunggu instruktur selesai tugas kantornya", "Mengajak pasukan untuk bermain HP masing-masing di lapangan", "Meninggalkan lapangan untuk mencari instruktur di kantornya", "Inisiatif mengambil alih pimpinan dan memulai pemanasan", "Tidur di bawah pohon sampai instruktur datang ke lapangan"] },
        { q: "Salah satu kancing baju seragam teman copot saat sudah berada di area VIP. Anda membawa jarum dan benang. Tindakan Anda?", o: ["Memberitahunya secara langsung bahwa baju seragamnya rusak", "Menertawakannya karena dianggap ceroboh dalam berseragam", "Segera membantunya menjahitkan dengan cepat sebelum dimulai", "Menyuruhnya mengganti baju dengan orang lain yang ukurannya pas", "Mengatakan kepada teman tersebut itu bukan urusan pribadi"] },
        { q: "Area perkemahan diguyur hujan deras dan air mulai masuk ke tenda. Apa langkah antisipasi Anda?", o: ["Menangis di dalam tenda dan meminta untuk pulang ke rumah", "Membiarkan saja karena tenda tersebut bukan milik pribadi", "Menyalahkan panitia karena salah memilih lokasi perkemahan", "Pindah ke tenda orang lain tanpa meminta izin terlebih dulu", "Sigap membuat parit di sekitar tenda dan amankan logistik"] }
    ]
};

const CORRECT_ANSWERS = {
    "Cageur": ["4", "2", "5", "2", "3"], "Bageur": ["2", "4", "1", "5", "3"],
    "Bener":  ["5", "2", "4", "1", "3"], "Pinter": ["3", "5", "2", "4", "1"],
    "Singer": ["2", "1", "4", "3", "5"]
};

// 1. FUNGSI MULAI (DENGAN CEK DATABASE)
document.getElementById('btnVerify').onclick = async () => {
    const token = document.getElementById('input-token').value.trim();
    if (!SEL_NAMA || !token) { Swal.fire("Peringatan", "Pilih Nama dan isi Token!", "warning"); return; }
    
    Swal.fire({ title: 'Verifikasi Akses...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
        const resp = await fetch(`${SCRIPT_URL}?action=verifyToken&nama=${encodeURIComponent(SEL_NAMA)}&token=${encodeURIComponent(token)}`);
        const res = await resp.json();

        if (res.alreadySubmitted) {
            Swal.fire({
                title: "Anda Sudah Mengisi!",
                html: `<div style="text-align:left; background:#f0f4f8; padding:15px; border-radius:10px; border:1px solid #c3dafe;">
                        <p style="text-align:center; margin-bottom:10px;">Data <b>${SEL_NAMA}</b> sudah ada di MPS sistem.</p>
                        <hr>
                        <p style="font-weight:bold; color:var(--primary); text-align:center; font-size:16px;">HASIL ANDA:</p>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                          <span>Cageur: <b>${res.data.cag}</b></span>
                          <span>Bageur: <b>${res.data.bag}</b></span>
                          <span>Bener : <b>${res.data.ben}</b></span>
                          <span>Pinter: <b>${res.data.pin}</b></span>
                          <span>Singer: <b>${res.data.sin}</b></span>
                        </div>
                        <h2 style="color:#b30077; text-align:center; font-weight:900; font-size:32px; margin-top:15px;">${res.data.avg}</h2>
                       </div>`,
                icon: "error"
            });
        } else if (res.valid) {
            TOKEN_VALID = true;
            document.getElementById('questions').style.display = "block";
            document.getElementById('btnNext').style.display = "block";
            document.getElementById('btnVerify').style.display = "none";
            renderQuestions(SEL_SESI);
            Swal.fire("Berhasil", "Token Valid. Silahkan kerjakan.", "success");
        } else {
            Swal.fire("Gagal", "Token Salah!", "error");
        }
    } catch (e) { Swal.fire("Error", "Gagal cek database.", "error"); }
};

// 2. FUNGSI RENDER SOAL (DENGAN WRAPPING)
function renderQuestions(sesi) {
    const container = document.getElementById('questions');
    container.innerHTML = `<h2 style="text-align:center; color:var(--primary); margin-bottom:20px;">Rubrik: ${sesi}</h2>`;
    QUEST_DATA[sesi].forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        const saved = userAnswers[`${sesi}_${i}`];
        if(saved) card.classList.add('locked');
        card.innerHTML = `<div class="q-text">${i+1}. ${item.q}</div>`;
        item.o.forEach((txt, idx) => {
            const val = (idx + 1).toString();
            const l = document.createElement('label');
            l.className = 'opt';
            if(saved === val) l.classList.add(val === CORRECT_ANSWERS[sesi][i] ? 'opt-correct' : 'opt-wrong');
            l.innerHTML = `<input type="radio" name="q${i}" value="${val}" ${saved === val ? 'checked':''} disabled> <span>${txt}</span>`;
            l.onclick = () => {
                if(card.classList.contains('locked')) return;
                userAnswers[`${sesi}_${i}`] = val;
                if(val === CORRECT_ANSWERS[sesi][i]) l.classList.add('opt-correct');
                else l.classList.add('opt-wrong');
                card.classList.add('locked');
                calculateScore();
            };
            card.appendChild(l);
        });
        container.appendChild(card);
    });
}

function calculateScore() {
    const sesis = ["Cageur", "Bageur", "Bener", "Pinter", "Singer"];
    const ids = ["score-cag", "score-bag", "score-ben", "score-pin", "score-sin"];
    sesis.forEach((s, idx) => {
        let score = 0;
        for(let i=0; i<5; i++) {
            const ans = userAnswers[`${s}_${i}`];
            if(ans === CORRECT_ANSWERS[s][i]) score += 20;
            else if(ans) score += 10;
        }
        document.getElementById(ids[idx]).textContent = score;
    });
}

// 3. FUNGSI SIMPAN & TAMPIL NILAI
document.getElementById('btnNext').onclick = async () => {
    if(Object.keys(userAnswers).length < 25) { Swal.fire("Peringatan", "Selesaikan semua soal!", "warning"); return; }
    
    const confirm = await Swal.fire({
        title: 'Kirim Jawaban?',
        text: "Pastikan data sudah benar. Anda tidak bisa mengulang!",
        icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Kirim!'
    });

    if(!confirm.isConfirmed) return;

    Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    const sCag = document.getElementById('score-cag').textContent;
    const sBag = document.getElementById('score-bag').textContent;
    const sBen = document.getElementById('score-ben').textContent;
    const sPin = document.getElementById('score-pin').textContent;
    const sSin = document.getElementById('score-sin').textContent;
    const avg = Math.round((parseInt(sCag)+parseInt(sBag)+parseInt(sBen)+parseInt(sPin)+parseInt(sSin))/5);

    const payload = {
        nama: SEL_NAMA, unit: SEL_UNIT, sesi: "LENGKAP", 
        token: document.getElementById('input-token').value.trim(),
        skor_cag: sCag, skor_bag: sBag, skor_ben: sBen, skor_pin: sPin, skor_sin: sSin,
        rata_rata: avg, jawaban: userAnswers
    };

    try {
        const resp = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const res = await resp.json();
        if(res.status === "success") {
            await Swal.fire({
                title: "Berhasil!",
                html: `<div style="text-align:center;">
                        <h2 style="color:var(--primary);">NILAI: ${avg}</h2>
                        <p>Data <b>${SEL_NAMA}</b> telah aman tersimpan.</p>
                       </div>`,
                icon: "success"
            });
            location.reload();
        }
    } catch(e) { Swal.fire("Error", "Gagal kirim data.", "error"); }
};

// 4. DROPDOWN LOGIC
function setupDropdown(triggerId, dropdownId, onSelect) {
    const trigger = document.getElementById(triggerId);
    const dropdown = document.getElementById(dropdownId);
    trigger.onclick = (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); };
    dropdown.onclick = (e) => {
        if(e.target.tagName === 'DIV') {
            const val = e.target.getAttribute('data-val') || e.target.textContent;
            trigger.textContent = val;
            dropdown.classList.remove('show');
            onSelect(val, e.target.getAttribute('data-idx'));
        }
    };
}
window.onclick = () => document.querySelectorAll('.floating-dropdown').forEach(d => d.classList.remove('show'));

setupDropdown('unit-trigger', 'unit-dropdown', (val, idx) => {
    SEL_UNIT = val; SEL_NAMA = "";
    document.getElementById('nama-trigger').textContent = "Pilih Nama";
    const namaDrop = document.getElementById('nama-dropdown');
    namaDrop.innerHTML = "";
    for(let r=1; r<RAW_DATA.length; r++) { if(RAW_DATA[r][idx]) namaDrop.innerHTML += `<div>${RAW_DATA[r][idx]}</div>`; }
});

setupDropdown('nama-trigger', 'nama-dropdown', (val) => { 
    SEL_NAMA = val; TOKEN_VALID = false;
    document.getElementById('questions').style.display = "none";
    document.getElementById('btnNext').style.display = "none";
    document.getElementById('btnVerify').style.display = "block";
});

setupDropdown('sesi-trigger', 'sesi-dropdown', (val) => { 
    SEL_SESI = val; if(TOKEN_VALID) renderQuestions(val); 
});

async function loadData() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=peserta`);
        RAW_DATA = await res.json();
        const unitDrop = document.getElementById('unit-dropdown');
        RAW_DATA[0].forEach((u, i) => { if(u) unitDrop.innerHTML += `<div data-idx="${i}">${u}</div>`; });
    } catch(e) {}
}
loadData();
</script>
</body>
</html>
