<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presensi Kehadiran</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { 
      --primary-green: #2d6a4f; 
      --soft-green: #e9f5ec; 
      --header-green: #1b4332; 
    }
    
    body { 
      background-color: var(--soft-green); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Satu Baris Identitas (Sticky) */
    .header-fixed {
      background-color: #ffffff;
      padding: 10px 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      z-index: 1050;
    }

    .filter-row {
      display: flex;
      gap: 8px; /* Jarak antar kotak rapat */
      width: 100%;
      margin: 0 auto;
    }

    /* Floating Dropdown Style */
    .form-floating {
      flex: 1;
    }
    .form-floating > .form-select, .form-floating > .form-control {
      padding-top: 1.625rem;
      padding-bottom: 0.625rem;
      border: 1px solid #ced4da;
      border-radius: 8px;
    }

    /* Tabel Section (Scrollable) */
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .table-wrapper {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      width: 100%; /* Memperlebar Tabel */
      box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    }

    /* Header Tabel Hijau Tulisan Putih Tebal */
    .table thead {
      position: sticky;
      top: 0;
      background-color: var(--header-green);
      color: #ffffff;
      z-index: 10;
    }
    
    .table thead th {
      font-weight: 800 !important;
      padding: 18px 15px;
      border: none;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    /* Logo Unit */
    .unit-logo {
      height: 40px;
      max-width: 100px;
      object-fit: contain;
    }

    .status-select {
      font-weight: 600;
      border-color: #2d6a4f;
    }

    /* Footer Action */
    .footer-action {
      background: white;
      padding: 12px;
      text-align: center;
      border-top: 2px solid var(--soft-green);
    }

    .btn-save { 
      background-color: var(--primary-green); 
      color: white; 
      font-weight: bold;
      border-radius: 10px;
      padding: 12px 60px;
      border: none;
      transition: all 0.2s;
    }
    
    .btn-save:hover { background-color: #1b4332; transform: translateY(-2px); }
    .btn-save:active { transform: translateY(0); }
  </style>
</head>
<body>

<div class="header-fixed">
  <div class="filter-row">
    <div class="form-floating">
      <select id="filterUnit" class="form-select" onchange="renderTable()">
        <option value="Semua Unit">Semua Unit</option>
      </select>
      <label for="filterUnit">UNIT</label>
    </div>

    <div class="form-floating">
      <select id="kegiatan" class="form-select">
        <option value="Diklat">Diklat</option>
        <option value="Bintal">Bintal</option>
        <option value="Bintur">Bintur</option>
      </select>
      <label for="kegiatan">KEGIATAN</label>
    </div>

    <div class="form-floating">
      <input type="date" id="tanggal" class="form-control" placeholder="Tanggal">
      <label for="tanggal">TANGGAL</label>
    </div>
  </div>
</div>

<div class="table-container">
  <div class="table-wrapper">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th width="80" class="text-center">NO</th>
          <th>NAMA</th>
          <th class="text-center" width="200">UNIT</th>
          <th width="200">STATUS</th>
        </tr>
      </thead>
      <tbody id="tabelBody">
        </tbody>
    </table>
  </div>
</div>

<div class="footer-action">
  <button onclick="simpanKehadiran()" id="btnSimpan" class="btn btn-save">
    SIMPAN DATA KEHADIRAN
  </button>
</div>

<script>
  let dataPeserta = [];
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec";

  const unitLogoMap = {
    "SMPN 1 Citeureup": "1_Citeureup.png",
    "SMPN 6 Depok": "6-removebg-preview (1).png",
    "SMPN 7 Depok": "7.png",
    "SMPN 8 Depok": "8-removebg-preview.png",
    "SMPN 12 Depok": "12-removebg-preview.png",
    "SMPN 16 Depok": "16-removebg-preview.png",
    "SMPN 31 Depok": "31-removebg-preview.png",
    "SMPN 32 Depok": "SMP_32.png"
  };

  window.onload = () => {
    document.getElementById('tanggal').valueAsDate = new Date();
    // Simulasi loading atau fetch data
    fetch(GAS_URL + "?action=getListData")
      .then(res => res.json())
      .then(res => {
        if(res.success) {
          dataPeserta = res.data.pesertabintal;
          const unitSelect = document.getElementById('filterUnit');
          res.data.units.forEach(u => {
            let opt = new Option(u, u);
            unitSelect.add(opt);
          });
          renderTable();
        }
      });
  };

  function renderTable() {
    const filter = document.getElementById('filterUnit').value;
    const tbody = document.getElementById('tabelBody');
    tbody.innerHTML = "";
    
    const filtered = filter === "Semua Unit" ? dataPeserta : dataPeserta.filter(p => p.unit === filter);
    
    filtered.forEach((p, i) => {
      const logoFile = unitLogoMap[p.unit];
      const unitDisplay = logoFile 
        ? `<img src="${logoFile}" class="unit-logo" title="${p.unit}" onerror="this.outerHTML='<b>${p.unit}</b>'">` 
        : `<b>${p.unit}</b>`;

      tbody.innerHTML += `
        <tr>
          <td class="text-center fw-bold text-muted">${i+1}</td>
          <td class="fw-bold">${p.nama}</td>
          <td class="text-center">${unitDisplay}</td>
          <td>
            <select class="form-select status-select" data-nama="${p.nama}" data-unit="${p.unit}">
              <option value="Hadir">Hadir</option>
              <option value="Ijin">Ijin</option>
              <option value="Sakit">Sakit</option>
              <option value="Absen">Absen</option>
            </select>
          </td>
        </tr>
      `;
    });
  }

  function simpanKehadiran() {
    const btn = document.getElementById('btnSimpan');
    const tgl = document.getElementById('tanggal').value;
    const keg = document.getElementById('kegiatan').value;
    
    if(!tgl) return alert("Pilih Tanggal!");
    
    btn.disabled = true;
    btn.innerText = "PROSES SIMPAN...";

    const seleksi = document.querySelectorAll('.status-select');
    const payload = Array.from(seleksi).map(s => ({
      nama: s.dataset.nama,
      unit: s.dataset.unit,
      status: s.value,
      tanggal: tgl,
      kegiatan: keg
    }));

    fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({ action: "saveKehadiran", data: payload })
    })
    .then(r => r.json())
    .then(res => {
      alert("Berhasil disimpan ke sheet kehadiran!");
      btn.disabled = false;
      btn.innerText = "SIMPAN DATA KEHADIRAN";
    })
    .catch(err => {
      alert("Terjadi gangguan koneksi.");
      btn.disabled = false;
      btn.innerText = "SIMPAN DATA KEHADIRAN";
    });
  }
</script>
</body>
</html>
