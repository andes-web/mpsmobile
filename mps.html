<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS - FIXED POS + NON TEKNIS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
body{margin:0;font-family:'Poppins',sans-serif;background:transparent;color:#1e293b;font-size:0.85rem;}
.sidebar{position:fixed;right:0;top:0;width:280px;height:100vh;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-left:1px solid #e2e8f0;box-shadow:-6px 0 20px rgba(0,0,0,0.1);display:flex;flex-direction:column;z-index:9999;}
.sidebar header{padding:8px 6px;background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:#fff;font-size:1.6rem;font-weight:700;display:flex;justify-content:space-between;align-items:center;position:relative;}
@media(min-width:769px){.sidebar{width:280px;position:fixed;height:100vh;}
.sidebar header{height:55px;padding:0 12px;background:linear-gradient(90deg,#4facfe,#00f2fe);font-size:1rem;font-weight:bold;color:white;box-shadow:0 4px 8px rgba(0,0,0,0.15);border-bottom:1px solid #ccc;}
.header-title{flex:1;text-align:center;font-size:1.2rem;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);}}
.sidebar main{flex:1;overflow-y:auto;padding:6px 8px;}
.top-controls{display:flex;gap:4px;margin-bottom:2px;align-items:center;}
select{flex-grow:1.5;padding:4px;border:1px solid #93c5fd;border-radius:6px;background:#f1f5f9;font-size:0.75rem;margin-bottom:0;}
.action-btns{display:flex;gap:3px;flex-grow:1;}
.action-btns button{flex:1;padding:4px 6px;font-size:0.8rem;border:none;border-radius:5px;color:#fff;cursor:pointer;font-weight:600;transition:all 0.1s ease;box-shadow:0 4px 0 rgba(0,0,0,0.2);}
.btn-pdf{background:#60a5fa;}.btn-excel{background:#4ade80;}
.tableBox{border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:2px;overflow:hidden;border:1px solid #e0e7ff;}
.tableBox table{width:100%;font-size:0.7rem;border-collapse:collapse;}
.tableBox th,.tableBox td{padding:2px 4px!important;text-align:center;border:none;}
.tableBox th{background:#1d4ed8;color:#fff;font-weight:600;border-bottom:1px solid #3b82f6;}
.tableBox td:nth-child(2){text-align:left;padding-left:8px;}
footer{text-align:center;font-size:0.8rem;padding:5px;}
</style>
</head>

<body>
<div class="sidebar">
  <header><span class="header-title">Rekap Nilai MPS</span></header>
  <main>
    <div class="top-controls">
      <select id="jenisRekap">
        <option value="Rekap">Rekap Individu</option>
        <option value="RekapKelompok">Rekap Kelompok</option>
        <option value="RekapAkhir">Rekap Akhir</option>
        <option value="Nilai_Lain">Rekap Non Teknis</option> <!-- ‚úÖ Tambahan baru -->
      </select>
      <div class="action-btns">
        <button class="btn-pdf" id="btnPDF">PDF</button>
        <button class="btn-excel" id="btnExcel">Excel</button>
      </div>
    </div>

    <div class="tableBox">
      <table id="rekapTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>
  <footer>¬© 2025 Andes | MPS System</footer>
</div>

<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbzQ6id-Lc0RSDYTaMQC483uBsGeBNoDO30bcEYqi8iyh5EN9EYtpdaXhF17R3VlGTFG/exec";
let latestData=[],refreshTimer=null;
function getRankDisplay(r){return r===1?"ü•á":r===2?"ü•à":r===3?"ü•â":r;}
async function fetchSheet(s){const r=await fetch(`${sheetAPI}?sheet=${s}`);return await r.json();}

async function loadRekap(sheetName="Rekap"){
 try{
  // === MODE REKAP AKHIR ===
  if(sheetName==="RekapAkhir"){
    const dataA=await fetchSheet("RekapAkhir");
    const rows=dataA.slice(1).map(r=>({nama:r[0],ni:+r[1]||0,nk:+r[2]||0,nn:+r[3]||0,na:+r[4]||0})).sort((a,b)=>b.na-a.na);
    const top=rows.slice(0,100);
    document.getElementById("rekapTable").classList.add("rekap-akhir");
    document.getElementById("tableHead").innerHTML=`<tr><th>üèÖ</th><th>Nama</th><th>NI</th><th>NK</th><th>NN</th><th>NA</th></tr>`;
    document.getElementById("tableBody").innerHTML=top.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r.nama}</td><td>${r.ni}</td><td>${r.nk}</td><td>${r.nn}</td><td>${r.na}</td></tr>`).join("");
    return;
  }

  // === MODE REKAP NON TEKNIS ===
  if(sheetName==="Nilai_Lain"){
    const dataNT=await fetchSheet("Nilai_Lain");
    const headers=dataNT[0];const rows=dataNT.slice(1);
    const namaIdx=headers.indexOf("Nama"),unitIdx=headers.indexOf("Unit"),jumlahIdx=headers.indexOf("Jumlah");
    const sorted=rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));
    const limit=50,topRows=sorted.slice(0,limit);
    document.getElementById("tableHead").innerHTML=`<tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr>`;
    document.getElementById("tableBody").innerHTML=topRows.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r[namaIdx]}</td><td>${r[unitIdx]}</td><td>${r[jumlahIdx]}</td></tr>`).join("");
    document.getElementById("rekapTable").classList.add("rekap-akhir");
    return;
  }

  // === MODE BIASA (INDIVIDU / KELOMPOK) ===
  const data=await fetchSheet(sheetName);latestData=data;
  const headers=data[0],rows=data.slice(1);
  const namaIdx=headers.indexOf("Nama"),unitIdx=headers.indexOf("Unit"),jumlahIdx=headers.indexOf("Jumlah");
  const sorted=rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));
  const limit=10,topRows=sorted.slice(0,limit);
  document.getElementById("tableHead").innerHTML="<tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jml</th></tr>";
  document.getElementById("tableBody").innerHTML=topRows.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r[namaIdx]}</td><td>${r[unitIdx]}</td><td>${r[jumlahIdx]}</td></tr>`).join("");
 }catch(e){console.error(e);}
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();
if(refreshTimer)clearInterval(refreshTimer);
refreshTimer=setInterval(()=>{const v=document.getElementById("jenisRekap").value;loadRekap(v);},10000);

document.getElementById("btnExcel").addEventListener("click",()=>{const ws=XLSX.utils.aoa_to_sheet(latestData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Rekap");XLSX.writeFile(wb,"Rekap_MPS.xlsx");});
document.getElementById("btnPDF").addEventListener("click",()=>{const {jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});doc.text("Rekap Nilai MPS",220,40);doc.autoTable({html:"#rekapTable",startY:60});doc.save("Rekap_MPS.pdf");});
</script>
</body>
</html>
