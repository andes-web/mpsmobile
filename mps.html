<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS - FIXED POS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
/* 1. Kerapatan dan Elegan/Modern */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: transparent;
  color: #1e293b;
  font-size: 0.85rem;
}
.sidebar {
  /* Aturan Default untuk Desktop (280px) */
  position: fixed;
  right: 0;
  top: 0;
  width: 280px; /* Lebar default: 280px */
  height: 100vh;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(10px);
  border-left: 1px solid #e2e8f0;
  box-shadow: -6px 0 20px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  z-index: 9999;
}
/* Header: Rata Tengah */
.sidebar header {
  padding: 8px 6px;
  /* Warna Default (Mobile): Biru Tua */
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: #fff;
  font-size: 1.6rem;
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

/* üåê DESKTOP OVERRIDES (min-width: 769px) */
@media (min-width: 769px) {
  /* Hapus FIX AGGRESIF (lebar) di sini, biar JS yang atur. */
  .sidebar {
    width: 280px; 
    position: fixed;
    height: 100vh;
  }
    
  .sidebar header {
    height: 55px; 
    padding: 0 12px;
    /* Memaksa gradien warna Desktop (Biru Muda) */
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    font-size: 1rem;
    font-weight: bold;
    color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-bottom: 1px solid #ccc;
  }
  .header-title {
    flex: 1;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 700;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
  }
}

/* Hapus CSS penyembunyian ikon di Desktop sebelumnya */


.sidebar main {
  flex: 1;
  overflow-y: auto;
  padding: 6px 8px;
}

/* Top Controls */
.top-controls {
  display: flex;
  gap: 4px;
  margin-bottom: 2px;
  align-items: center;
}
select {
  flex-grow: 1.5;
  padding: 4px;
  border: 1px solid #93c5fd;
  border-radius: 6px;
  background: #f1f5f9;
  font-size: 0.75rem;
  margin-bottom: 0;
  transition: border-color 0.3s;
}
select:focus {
  border-color: #2563eb;
}
.action-btns {
    display: flex;
    gap: 3px;
    flex-grow: 1;
}
/* Tombol 3D Warna Terang */
.action-btns button {
  flex: 1;
  padding: 4px 6px;
  font-size: 0.8rem;
  border: none;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.1s ease;
  
  /* Styling 3D */
  box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
  transform: translateY(0);
}

.btn-pdf { background: #60a5fa; } /* Blue 400 */
.btn-excel { background: #4ade80; } /* Green 400 */

.action-btns button:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
}

/* Stat Box (1 baris) */
.statBox {
  display: flex;
  justify-content: space-between;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #bfdbfe;
  border-radius: 6px;
  padding: 0px 2px;
  margin-bottom: 2px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.statItem { 
  text-align: center;
  flex: 1;
  padding: 0 3px;
}
.statItem h5 { font-size: 0.45rem; margin: 0 0 1px 0; color: #64748b; font-weight: 400; }
.statItem p { font-size: 0.9rem; font-weight: 800; color: #1d4ed8; margin: 0; }

/* CSS BARU: Prosentase */
.statBox .statProsentase {
    font-size: 1.1rem !important; /* Larger */
    font-weight: 900 !important; /* Bolder */
}
/* Warna Default: Merah (untuk < 100%) */
.statBox .statProsentase-red {
    color: #dc2626 !important; /* Stronger Red (Red 600) */
}
/* Warna 100%: Hijau */
.statBox .statProsentase-green {
    color: #10b981 !important; /* Strong Green (Green 500) */
}


/* Tabel Rekap (Peringkat) Elegan */
.tableBox {
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-bottom: 2px;
  overflow: hidden;
  border: 1px solid #e0e7ff;
}
.tableBox table {
  width: 100%;
  font-size: 0.7rem;
  border-collapse: collapse;
}
.tableBox th, .tableBox td { 
  padding: 2px 4px !important;
  text-align: center;
  border: none;
}
.tableBox th { 
  background: #1d4ed8; 
  color: #fff; 
  font-weight: 600;
  border-bottom: 1px solid #3b82f6;
}
/* Modifikasi: Kolom peringkat di tengah */
.tableBox th:nth-child(1) { 
    width: 12%; 
}
.tableBox td:nth-child(1) {
    width: 12%; 
    font-weight: 700;
}
.tableBox td:nth-child(2) { text-align: left; font-weight: 500; }
.tableBox td:nth-child(3) { color: #4b5563; font-size: 0.65rem; }
.tableBox tr:nth-child(even) td { background: #f9faff; }
.tableBox tr:hover td { background: #eff6ff; }
.tableBox tr:hover td:nth-child(1) { background: #bfdbfe; }

/* üîß Lebar kolom rekap akhir dan umum */
.tableBox table th:nth-child(1),
.tableBox table td:nth-child(1) {
  width: 10%; /* kolom peringkat */
}

/* Lebar Kolom untuk REKAP AKHIR (5 kolom: üèÖ, Nama, NI, NK, NA) */
.tableBox table.rekap-akhir th:nth-child(2),
.tableBox table.rekap-akhir td:nth-child(2) {
  width: 50%; /* kolom Nama lebih lebar */
  text-align: left;
  padding-left: 8px;
}

.tableBox table.rekap-akhir th:nth-child(3),
.tableBox table.rekap-akhir td:nth-child(3) {
  width: 8%; /* kolom NI */
}

.tableBox table.rekap-akhir th:nth-child(4),
.tableBox table.rekap-akhir td:nth-child(4) {
  width: 8%; /* kolom NK */
}

.tableBox table.rekap-akhir th:nth-child(5),
.tableBox table.rekap-akhir td:nth-child(5) {
  width: 8%; /* kolom NN */
}

.tableBox table.rekap-akhir th:nth-child(6),
.tableBox table.rekap-akhir td:nth-child(6) {
  width: 18%; /* kolom NA */
  font-weight: 700;
}

/* üéØ Lebar Kolom untuk REKAP INDIVIDU/KELOMPOK (4 kolom: üèÖ, Nama, Unit, Jumlah) */
.tableBox table:not(.rekap-akhir) th:nth-child(2),
.tableBox table:not(.rekap-akhir) td:nth-child(2) {
    width: 50%; /* Nama disesuaikan */
    text-align: left;
    padding-left: 8px;
}
.tableBox table:not(.rekap-akhir) th:nth-child(3),
.tableBox table:not(.rekap-akhir) td:nth-child(3) {
    width: 30%; /* Unit dilebarkan untuk 15 karakter */
}
.tableBox table:not(.rekap-akhir) th:nth-child(4),
.tableBox table:not(.rekap-akhir) td:nth-child(4) {
    width: 10%; /* Jml dikecilkan (Max 3 char) */
}


/* Tabel POS Elegan dan Proporsional */
.posTable {
  margin-top: 2px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid #e0e7ff;
}
.posTable h4 {
  padding: 5px 8px;
  font-size: 0.75rem;
  background: #374151;
  color: white;
  margin: 0;
}
.posTable table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
}
.posTable th {
  background: #4b5563 !important;
  color: white;
  border-bottom: 1px solid #9ca3af;
  font-weight: 500;
}
.posTable table th,
.posTable table td {
  width: 20%;
}

.posTable td { 
    font-size: 0.65rem; 
    background: #fefefe;
    text-align: center;
}

/* ======== Pewarnaan Nilai POS (final) ======== */
.posTable td.pos-value {
  /* Ukuran dan ketebalan seragam untuk semua nilai */
  font-size: 0.9rem !important;
  font-weight: 700 !important;
  vertical-align: middle;
  transition: all 0.2s ease-in-out;
  color: #1e293b; 
}

.posTable td.pos-max {
  color: #1e3a8a !important;         /* Biru Tua untuk MAKSIMUM */
  background: transparent !important;
  font-weight: 700 !important; 
  font-size: 0.9rem !important; 
}

.posTable td.pos-min {
  color: #dc2626 !important;         /* Merah Tua untuk SEMUA SELAIN MAKSIMUM */
  background: transparent !important;
  font-weight: 700 !important; 
  font-size: 0.9rem !important; 
}


/* Pastikan sel data non-angka (misal: teks) di kolom pertama tetap berukuran normal */
.posTable td:first-child {
    font-size: 0.65rem;
    font-weight: normal;
}

/* Warna Header POS */
.posTable th:nth-child(1) { background: #a5b4fc !important; }
.posTable th:nth-child(2) { background: #6ee7b7 !important; }
.posTable th:nth-child(3) { background: #fcd34d !important; }
.posTable th:nth-child(4) { background: #fb923c !important; }
.posTable th:nth-child(5) { background: #c084fc !important; }


/* Bar Chart Horizontal */
.unit-recap-bar {
  margin-top: 2px;
  background: #fff;
  border: 1px solid #e0e7ff;
  border-radius: 8px;
  padding: 6px 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.unit-recap-bar h4 {
  margin: 0 0 6px 0;
  font-size: 0.8rem;
  color: #1d4ed8;
  text-align: center;
  border-bottom: 1px dashed #d1d5db;
  padding-bottom: 4px;
}
.unit-recap-bar h4 span {
  font-weight:400;
  font-size:0.7em;
  color:#6b7280;
}
.bar-container {
  display: flex;
  flex-direction: column;
  gap: 2px !important;
}
.bar-item {
  height: 18px !important;
  background: #f3f4f6;
  border-radius: 4px;
  display: flex;
  align-items: center;
  position: relative;
  overflow: visible; /* Diubah dari hidden */
}
.bar-fill {
  height: 100%;
  transition: width 0.5s ease-out;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
  position: relative; /* Anchor untuk ::after */
}
.bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  right: -11px; /* Jarak agar ujung panah berada tepat di akhir batang */
  width: 0;
  height: 0;
  border-top: 11px solid transparent; 
  border-bottom: 11px solid transparent; 
  border-left: 11px solid var(--bar-color); 
  z-index: 2; 
}
.bar-label {
  position: absolute;
  left: 6px;
  right: 6px;
  color: #1f2937;
  font-size: 0.65rem;
  font-weight: 600;
  z-index: 3; /* Pastikan label berada di atas panah */
  display: flex;
  justify-content: space-between;
}
.bar-label span:last-child {
  background: rgba(255, 255, 255, 0.4);
  color: #1d4ed8;
  padding: 1px 4px;
  border-radius: 3px;
  font-weight: 700;
}

/* Copyright di Tengah */
footer {
  font-size: 0.9rem;
  padding: 3px;
  text-align: center;
}
.footer-link {
    font-weight: 700; /* BOLD */
    text-decoration: none; /* NO UNDERLINE */
    color: inherit; /* INHERIT COLOR */
    cursor: pointer;
}
.footer-link:hover, .footer-link:visited {
    color: inherit; 
}

/* ======================================= */
/* Tambahan CSS untuk Nilai Individu (dari rightsidebar9.html) */
/* ======================================= */
.tableBox table.rekap-nilai-individu th {
    font-size: 0.75rem;
}
.tableBox table.rekap-nilai-individu td {
    font-size: 0.7rem;
}
.input-controls label {
    white-space: nowrap;
}
/* ======================================= */


</style>
<style>
    /* üåê Tampilan umum */
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background: #fff;
    }

    /* ===== Tampilan penuh hanya di MOBILE (Diperbaiki untuk Scrolling) ===== */
@media (max-width: 768px) {
    #mobileHeader {
        display: none !important;
    }
    
    .sidebar {
        position: static !important;
        width: 100vw !important;
        height: 100vh !important; /* PENTING: Tinggi penuh */
        min-height: 100vh !important;
        margin-top: 0; 
        border: none !important;
        box-shadow: none !important;
        display: flex;
        flex-direction: column;
        overflow-y: hidden; /* Sidebar sendiri tidak boleh di scroll */
    }
    
    .sidebar main {
        flex: 1; /* PENTING: Mengambil semua ruang sisa */
        overflow-y: auto; /* PENTING: Area yang bisa di scroll */
        padding: 8px 10px;
        height: auto; /* Hapus height fix */
    }
    
    .sidebar footer {
    flex-shrink: 0;
    height: 30px;
    padding: 5px;
    background: #f1f5f9;
  }
}

    /* üíª Desktop tetap normal */
    @media (min-width: 769px) {
      #mobileHeader {
        display: none !important; 
      }
      .sidebar main {
        overflow-y: auto;
      }
    }

    /* üåê DESKTOP: samakan tampilan header dengan index.html... */

@media (min-width: 769px) {
  .sidebar header {
    height: 55px !important;
    padding: 0 12px !important;
    background: linear-gradient(90deg, #4facfe, #00f2fe) !important;
    font-size: 1rem !important;
    font-weight: bold !important;
    color: white !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    border-bottom: 1px solid #ccc !important;
  }
  .header-title {
    flex: 1 !important;
    text-align: center !important;
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.3) !important;
  }
}
</style>
<style>
@media (min-width: 769px) {
  .sidebar header {
    height: 54px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 12px !important;
  }
  .sidebar header .header-title {
    flex: 0 0 auto !important;
    text-align: center !important;
    font-size: 1.4rem !important; /* perbesar ukuran title */
    font-weight: 800 !important;
    color: white !important;
    width: 100%;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
  }
}
</style>
<style>
#mobileHeader {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 55px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
  z-index: 2000;
  margin: 0;
}
#menuToggle {
  font-size: 26px;
  font-weight: 900;
  color: white;
  cursor: pointer;
  margin-left: 4px;
  flex-shrink: 0;
}
#mobileHeader .header-title {
  flex: 1;
  text-align: center;
  font-size: 1.1rem;
  font-weight: 700;
  color: white;
  margin-left: -30px;
}
#btnHome svg, .home-icon-btn svg {
  fill: white;
  width: 32px;
  height: 32px;
}
#mobileSubmenu {
  display: none;
  position: fixed;
  top: 55px;
  left: 10px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  z-index: 1999;
  white-space: nowrap;
}
#mobileSubmenu.show {
  display: block;
}
#mobileSubmenu a {
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  color: #1e293b;
  font-size: 0.85rem;
  border-bottom: 1px solid #f1f5f9;
}
#mobileSubmenu a:last-child {
  border-bottom: none;
}
#mobileSubmenu a:hover {
  background: #f0f9ff;
  color: #2563eb;
}
</style>
</head>
<body>

<div id="mobileHeader" style="display:none; visibility:hidden;">
  <div id="menuToggle">‚ò∞</div>
  <div class="header-title">Rekap Nilai MPS</div>
  <div id="btnHome" class="home-icon-btn" style="width: 40px; text-align: right;">
    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
  </div>
</div>

<div class="sidebar">
  <header>
    <div class="header-title">REKAP NILAI</div>
    <div id="menuToggle" style="display:none; visibility:hidden;">‚ò∞</div>
    <div id="btnHome" class="home-icon-btn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"> <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/> </svg>
    </div>
  </header>
  <main>
    <div class="top-controls">
      <select id="jenisRekap">
        <option value="Rekap">Rekap Individu</option>
        <option value="RekapKelompok">Rekap Kelompok</option>
        <option value="NilaiIndividu">Nilai Individu</option> <option value="RekapAkhir">Rekap Akhir</option>
      </select>
      <div class="action-btns">
        <button class="btn-pdf" id="btnPDF">PDF</button>
        <button class="btn-excel" id="btnExcel">Excel</button>
      </div>
    </div>

    <div id="nilaiIndividuView" style="display:none;">
        <div class="input-controls" style="display: flex; gap: 8px; margin-bottom: 5px;">
            <label for="pesertaSelect" style="flex-shrink: 0; align-self: center;">Peserta:</label>
            <select id="pesertaSelect" style="flex-grow: 1.5;"></select>
            <div style="display: flex; gap: 3px; flex-grow: 1;">
                <select id="unitSelect" style="flex-grow: 1; margin-bottom: 0px !important;"></select>
                <button id="btnTampilkanNilai" class="action-btns button" style="flex-grow: 1; padding: 4px 6px; font-size: 0.8rem; border: none; border-radius: 5px; color: #fff; cursor: pointer; font-weight: 600; background: #2563eb; transition: all 0.1s ease; box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: -2px;"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
        <div class="tableBox" id="nilaiRekapTableContainer">
            <p style="text-align: center; color: #64748b; padding: 10px;">Pilih peserta dan klik tombol "Enter" untuk menampilkan rekap nilai.</p>
        </div>
    </div>
    <div class="statBox">
      <div class="statItem"><h5>Peserta</h5><p id="statPeserta">0</p></div>
      <div class="statItem"><h5>Rata</h5><p id="statRata">0</p></div>
      <div class="statItem"><h5>Tinggi</h5><p id="statMax">0</p></div>
      <div class="statItem"><h5>Rendah</h5><p id="statMin">0</p></div>
      <div class="statItem"><h5>Prosentase</h5><p id="statProsentase" class="statProsentase statProsentase-red">0%</p></div>
    </div>
    <div class="tableBox">
      <table id="rekapTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="posTable" id="posSection" style="display:none;">
      <h4 id="posTitle"></h4>
      <table id="posTable">
        <thead id="posHead"></thead>
        <tbody id="posBody"></tbody>
      </table>
    </div>
    <div class="unit-recap-bar">
      <h4 id="unitRecapTitle">Rerata Nilai Unit<span></span></h4>
      <div id="unitBarContainer" class="bar-container">
      </div>
    </div>
  </main>
  <footer>
    <a href="https://andes-web.github.io/mpsmobile/solo/spreadsheet.html" target="_blank" class="footer-link"> ¬© 2025 Andes | MPS System </a>
  </footer>
</div>

<div id="mobileSubmenu" style="display:none; visibility:hidden;"></div>

<script>
// --- KONSTANTA AKSES DATA GOOGLE APPS SCRIPT (diperbarui) ---
// PASTIKAN URL INI BENAR DAN MERUPAKAN DEPLOYMENT TERBARU!
const GAS_URL = "https://script.google.com/macros/s/AKfycbz1f1GTOvXWgrTAuV2in71WDsBohZRd3QdBNGh0xxq_a4xk9ijK3y28cOBNUbUjuLs/exec";
let latestData=[], refreshTimer=null; // PENTING: Pertahankan variabel ini
// Warna soft untuk batang unit
const softColors = [ 
  '#93c5fd', '#6ee7b7', '#fcd34d', '#fb923c', '#c4b5fd', 
  '#f97316', '#34d399', '#22d3ee', '#f472b6', '#a78bfa' 
]; 

// FUNGSI PERINGKAT: Menggunakan ikon hanya untuk 3 besar
function getRankDisplay(rank){ return rank===1?"ü•á":rank===2?"ü•à":rank===3?"ü•â":rank; }

// ===============================================
// --- FUNGSI TAMBAHAN UNTUK NILAI INDIVIDU (dari rightsidebar9.html) ---
// ===============================================

/**
 * Normalizes a key (e.g., 'Pemahaman Materi' to 'Pemahaman_Materi') to match the fetchSheetData output keys.
 * @param {string} str
 */
function normalizeKey(str) {
  return str.toString().trim().replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
}

/**
 * Fungsi untuk mengambil data dari Google Sheet melalui Apps Script.
 * @param {string} sheetName - Nama Sheet yang akan diambil.
 * @returns {Promise<object>} - Mengembalikan objek { headers, rows: array of objects }
 */
async function fetchSheetData(sheetName) {
  const url = `${GAS_URL}?sheet=${sheetName}`;
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Gagal mengambil data dari sheet ${sheetName} (Status: ${response.status})`);
    }
    const data = await response.json();
    if (data.error) {
      Swal.fire('Error Data', `Error saat memproses data sheet "${sheetName}": ${data.error}`, 'error');
      return { headers: [], rows: [] };
    }
    // Normalize keys for easy object access
    const normalizedHeaders = data.headers.map(h => normalizeKey(h));
    const normalizedRows = data.rows.map(row => {
      const newRow = {};
      data.headers.forEach((originalHeader, index) => {
        // Asumsi data dari Apps Script berupa object dengan key adalah header
        // Kita ambil nilai berdasarkan header asli dan simpan dengan key yang dinormalisasi
        newRow[normalizedHeaders[index]] = row[originalHeader]; 
      });
      return newRow;
    });
    
    return { 
      headers: normalizedHeaders, 
      rows: normalizedRows 
    };
  } catch (error) {
    console.error(`Fetch error for sheet ${sheetName}:`, error);
    // Tampilkan notifikasi error yang jelas
    Swal.fire('Error Koneksi/Akses', `Gagal memuat data untuk sheet "${sheetName}". Cek koneksi internet, pastikan **GAS_URL** benar, dan deployment Apps Script memiliki akses publik ('Anyone').`, 'error');
    return { headers: [], rows: [] };
  }
}

/**
 * Mengkonversi nilai angka menjadi predikat TB-SB.
 * @param {number} nilai
 * @returns {string} Predikat
 */
function getPredikat(nilai) {
  nilai = Math.round(nilai); // Pastikan nilai adalah integer
  if (nilai === 1) return "TB"; // Tidak Baik
  if (nilai === 2) return "KB"; // Kurang Baik
  if (nilai === 3) return "CB"; // Cukup Baik
  if (nilai === 4) return "B"; // Baik
  if (nilai === 5) return "SB"; // Sangat Baik
  return "-";
}


/**
 * Menampilkan view untuk Nilai Individu (Input dan Tabel Rekap) menggunakan data real.
 */
async function renderNilaiIndividu() {
  const resultContainer = document.getElementById('nilaiRekapTableContainer');
  resultContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 10px;">Mengambil daftar peserta...</p>';

  const pesertaSelect = document.getElementById('pesertaSelect');
  const unitSelect = document.getElementById('unitSelect');
  
  // 1. Populasi Dropdown Unit dan Peserta dari sheet "Rekap"
  const rekapData = await fetchSheetData('Rekap');
  const pesertaList = rekapData.rows;
  
  if (pesertaList.length === 0) {
    resultContainer.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 10px; font-weight: 600;">Gagal memuat data Rekap. Pastikan Sheet "Rekap" ada dan terisi.</p>';
    return;
  }
  
  // Ambil daftar unik peserta dan unit
  const namaKey = normalizeKey('Nama');
  const unitKey = normalizeKey('Unit');

  pesertaSelect.innerHTML = '<option value="">-- Pilih Peserta --</option>';
  const uniquePeserta = [...new Set(pesertaList.map(r => r[namaKey]).filter(n => n))].sort();
  uniquePeserta.forEach(nama => {
    pesertaSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
  });

  unitSelect.innerHTML = '<option value="">-- Semua Unit --</option>';
  const uniqueUnit = [...new Set(pesertaList.map(r => r[unitKey]).filter(u => u))].sort();
  uniqueUnit.forEach(unit => {
    unitSelect.innerHTML += `<option value="${unit}">${unit}</option>`;
  });

  // 2. Implementasi Tombol 'Tampilkan Nilai'
  document.getElementById('btnTampilkanNilai').onclick = async () => {
    const selectedPeserta = pesertaSelect.value;
    if (!selectedPeserta) {
      Swal.fire('Peringatan', 'Silakan pilih Nama Peserta terlebih dahulu.', 'warning');
      return;
    }

    resultContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 10px;">Memproses data nilai...</p>';
    const cleanName = selectedPeserta.toString().trim();

    try {
      // Fetch all necessary detail sheets simultaneously
      const [rekapI, rekapK, rekapN] = await Promise.all([
        fetchSheetData('Rekap'),
        fetchSheetData('RekapKelompok'),
        fetchSheetData('Nilai_Lain')
      ]);

      // Combine all sheets' data into one map for easy lookup
      const combinedScores = {};
      [rekapI, rekapK, rekapN].forEach(sheet => {
        if (sheet.headers.includes(namaKey) && sheet.rows) {
          sheet.rows.forEach(row => {
            if (row[namaKey] === cleanName) {
              Object.assign(combinedScores, row);
            }
          });
        }
      });

      if (Object.keys(combinedScores).length === 0) {
        resultContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 10px; font-weight: 600;">Data nilai tidak ditemukan untuk ${cleanName} di semua sheet.</p>`;
        return;
      }

      // Define the structure and map the keys
      const scoreMapping = [
        // A. PENILAIAN INDIVIDU (from 'Rekap')
        { header: 'A. PENILAIAN INDIVIDU' },
        { display: 'Kedisiplinan', key: normalizeKey('Kedisiplinan') },
        { display: 'Kekompakan', key: normalizeKey('Kekompakan') },
        { display: 'Pemahaman Materi', key: normalizeKey('Pemahaman Materi') },

        // B. PENILAIAN KELOMPOK (from 'RekapKelompok')
        { header: 'B. PENILAIAN KELOMPOK' },
        { display: 'Kekompakan Kelompok', key: normalizeKey('Kekompakan Kelompok') },
        { display: 'Kerjasama & Kolaborasi', key: normalizeKey('Kerjasama & Kolaborasi') },
        { display: 'Ketekukan & Daya Juang', key: normalizeKey('Ketekukan & Daya Juang') },

        // C. PENILAIAN NON TEKNIS (from 'Nilai_Lain')
        { header: 'C. PENILAIAN NON TEKNIS' },
        { display: 'Sikap', key: normalizeKey('Sikap') },
        { display: 'Perilaku', key: normalizeKey('Perilaku') },
        { display: 'Kehadiran', key: normalizeKey('Kehadiran') },
        { display: 'Inisiatif', key: normalizeKey('Inisiatif') },
        { display: 'Kemauan Belajar', key: normalizeKey('Kemauan Belajar') },
      ];

      let tableHTML = `<table class="rekap-nilai-individu"><thead><tr><th>No</th><th style="text-align: left; padding-left: 15px;">Kriteria Penilaian</th><th>Nilai (1-5)</th><th>Predikat</th></tr></thead><tbody>`;
      let counter = 1;
      let totalNilai = 0;

      scoreMapping.forEach(item => {
        if (item.header) {
          // Header row
          tableHTML += `<tr><td colspan="4" style="text-align: left; background: #e0f2fe; color: #1d4ed8; padding: 4px 8px !important; font-weight: 700;">${item.header}</td></tr>`;
          counter = 1; // Reset counter for new section
          return;
        }

        // Get score from the combined map using the key
        const nilai = combinedScores[item.key] || 0;
        const predikat = getPredikat(nilai);
        
        tableHTML += `
          <tr>
            <td>${counter++}</td>
            <td style="text-align: left; padding-left: 15px;">${item.display}</td>
            <td>${nilai}</td>
            <td style="font-weight: 600;">${predikat}</td>
          </tr>
        `;
        totalNilai += Number(nilai);
      });

      // Total Row
      tableHTML += `
        <tr style="background: #1d4ed8; color: white; font-weight: 800;">
          <td colspan="2" style="text-align: center; padding-left: 8px;">Total Penilaian</td>
          <td colspan="2">${totalNilai}</td>
        </tr>
      `;

      tableHTML += `</tbody></table>`;
      resultContainer.innerHTML = tableHTML;

    } catch (error) {
      resultContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 10px; font-weight: 600;">Gagal memuat detail nilai. Cek koneksi atau Apps Script.</p>`;
      console.error(error);
    }
  };
  
  // Implement the 3D button effect on click/touch for the Tampilkan Nilai button
  const btnTampilkanNilai = document.getElementById('btnTampilkanNilai');
  if (btnTampilkanNilai) {
      btnTampilkanNilai.onmousedown = () => {
          btnTampilkanNilai.style.transform = 'translateY(2px)';
          btnTampilkanNilai.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.2)';
      };
      btnTampilkanNilai.onmouseup = btnTampilkanNilai.onmouseleave = () => {
          btnTampilkanNilai.style.transform = 'translateY(0)';
          btnTampilkanNilai.style.boxShadow = '0 4px 0 rgba(0, 0, 0, 0.2)';
      };
      btnTampilkanNilai.ontouchstart = (e) => {
          e.preventDefault();
          btnTampilkanNilai.style.transform = 'translateY(2px)';
          btnTampilkanNilai.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.2)';
      };
      btnTampilkanNilai.ontouchend = () => {
          btnTampilkanNilai.style.transform = 'translateY(0)';
          btnTampilkanNilai.style.boxShadow = '0 4px 0 rgba(0, 0, 0, 0.2)';
      };
  }

  // Trigger initial load if a participant is already selected (e.g., from refresh)
  if (pesertaSelect.value) {
      setTimeout(() => document.getElementById('btnTampilkanNilai').click(), 0);
  }
}

// ===============================================
// --- FUNGSI UTAMA UNTUK MENANGANI PERUBAHAN DROPDOWN (MODIFIKASI ROBUST) ---
// ===============================================
async function loadData(sheetName) {
    // üì¢ DEBUG 1: Konfirmasi fungsi loadData dipanggil
    console.log(`[DEBUG 1] loadData dipanggil untuk sheet: ${sheetName}.`);
    
    const isNilaiIndividu = sheetName === "NilaiIndividu";
    
    // --- PERBAIKAN: Tampilkan/Sembunyikan view secara SINKRONUS dan INSTAN ---
    
    // Sembunyikan semua section data/rekap standar
    document.querySelector(".statBox").style.display = "none";
    document.querySelector(".tableBox").style.display = "none";
    document.getElementById("posSection").style.display = "none";
    document.getElementById("unitRecapTitle").style.display = "none";
    document.getElementById("unitBarContainer").style.display = "none";

    // Tampilkan hanya view yang dipilih
    document.getElementById("nilaiIndividuView").style.display = isNilaiIndividu ? "block" : "none";
    
    // üì¢ DEBUG 2: Konfirmasi perubahan view terjadi
    console.log(`[DEBUG 2] Status nilaiIndividuView: ${document.getElementById("nilaiIndividuView").style.display}`);

    if (isNilaiIndividu) {
        // Jika Nilai Individu, panggil render khusus dan berhenti
        await renderNilaiIndividu();
        return; 
    }
    
    // Jika mode Rekap lainnya: tampilkan kembali section standar yang relevan
    document.querySelector(".statBox").style.display = ""; // Tampilkan Stat Box
    document.querySelector(".tableBox").style.display = "block"; // Tampilkan Table Box
    document.getElementById("unitRecapTitle").style.display = ""; // Tampilkan Unit Recap
    document.getElementById("unitBarContainer").style.display = ""; // Tampilkan Unit Bar

    // --- AWAL LOGIC LAMA YANG DIKONVERSI MENGGUNAKAN fetchSheetData ---
    
    const dataObj = await fetchSheetData(sheetName);
    const data = dataObj.rows; 

    if (!data || data.length === 0) {
        document.getElementById("tableBody").innerHTML = `<tr><td colspan="4" style="text-align: center; color: #dc2626; font-weight: 600; padding: 10px;">Gagal memuat data atau data kosong untuk ${sheetName}.</td></tr>`;
        document.getElementById("posSection").style.display = "none";
        document.querySelector(".statBox").style.display = "none";
        document.getElementById("unitRecapTitle").style.display = "none";
        document.getElementById("unitBarContainer").style.display = "none";
        return;
    }

    // === REKAP AKHIR LOGIC (Adapted from X.html) ===
    if (sheetName === "RekapAkhir") {
        // Sembunyikan semua yang tidak relevan untuk Rekap Akhir (hanya tabel)
        document.querySelector(".statBox").style.display = "none"; 
        document.getElementById("unitRecapTitle").style.display = "none";
        document.getElementById("unitBarContainer").style.display = "none";

        const topInd = data.slice(0, 100);
        document.getElementById("rekapTable").classList.add("rekap-akhir");
        document.getElementById("tableHead").innerHTML = `<tr><th>üèÖ</th><th>Nama</th><th>NI</th><th>NK</th><th>NN</th><th>NA</th></tr>`;

        const combined = topInd.map((r, i) => {
            // Gunakan nama kunci yang dinormalisasi
            const nama = r[normalizeKey("Nama")] || "";
            const ni = r[normalizeKey("NI")] || 0;
            const nk = r[normalizeKey("NK")] || 0;
            const nn = r[normalizeKey("NN")] || 0;
            const na = r[normalizeKey("NA")] || 0;

            return `
              <tr> 
                <td>${getRankDisplay(i + 1)}</td> 
                <td style="text-align:left;padding-left:8px;">${nama}</td> 
                <td>${ni}</td> 
                <td>${nk}</td> 
                <td>${nn}</td> 
                <td>${na}</td> 
              </tr>
            `;
        }).join("");

        document.getElementById("tableBody").innerHTML = combined;
        return;
    }

    // Hapus class untuk CSS Rekap Individu/Kelompok
    document.getElementById("rekapTable").classList.remove("rekap-akhir");

    // === REKAP BIASA (INDIVIDU/KELOMPOK) LOGIC (Adapted from X.html) ===
    latestData = data;
    const headers = dataObj.headers; 

    const namaKey = normalizeKey("Nama");
    const unitKey = normalizeKey("Unit");
    const jumlahKey = normalizeKey("Jumlah");

    // Urutkan data berdasarkan Jumlah
    const sorted = data.sort((a, b) => Number(b[jumlahKey] || 0) - Number(a[jumlahKey] || 0));

    const limit = 10;
    const topRows = sorted.slice(0, limit);

    document.getElementById("tableHead").innerHTML = "<tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jml</th></tr>";
    document.getElementById("tableBody").innerHTML = topRows.map((r, i) => `
        <tr>
          <td>${getRankDisplay(i + 1)}</td>
          <td>${r[namaKey] || ""}</td>
          <td>${r[unitKey] || ""}</td>
          <td>${r[jumlahKey] || 0}</td>
        </tr>
    `).join("");

    const arr = data.map(r => parseFloat(r[jumlahKey]) || 0).filter(v => v > 0);
    const n = arr.length, sum = arr.reduce((a, b) => a + b, 0);

    // UPDATE STATS
    document.getElementById("statPeserta").innerText = n;
    document.getElementById("statRata").innerText = n ? (sum / n).toFixed(1) : 0;
    document.getElementById("statMax").innerText = n ? Math.max(...arr) : 0;
    document.getElementById("statMin").innerText = n ? Math.min(...arr) : 0;

    // POS data & PROSENTASE CALCULATION (ROBUST VERSION)
    const posHeaders = headers.filter(h => h.toLowerCase().startsWith('pos') || h === namaKey || h === unitKey);
    
    if (posHeaders.length > 0) {
        const posOnlyHeaders = posHeaders.filter(h => h.toLowerCase().startsWith('pos'));
        const posRows = data.map(r => {
            const rowObj = {};
            posHeaders.forEach(h => { rowObj[h] = r[h]; });
            return rowObj;
        });

        // LOGIC PROSENTASE (Hanya hitung POS columns)
        const totalRows = posRows.length;
        let completeCount = 0;
        posRows.forEach(row => {
            const nonZeroCount = posOnlyHeaders.filter(h => parseFloat(String(row[h]).replace(',', '.')) > 0).length;
            if (nonZeroCount === posOnlyHeaders.length) {
                completeCount++;
            }
        });
        const prosentase = totalRows > 0 ? ((completeCount / totalRows) * 100).toFixed(0) : 0;
        const statProsentaseElement = document.getElementById("statProsentase");
        statProsentaseElement.innerText = `${prosentase}%`;
        if (prosentase === "100") {
            statProsentaseElement.className = `statProsentase statProsentase-green`;
        } else {
            statProsentaseElement.className = `statProsentase statProsentase-red`;
        }

        document.getElementById("posSection").style.display = "block";
        document.getElementById("posTitle").innerText = sheetName === "Rekap" ? "Rekap POS Individu" : "Rekap POS Kelompok";
        document.getElementById("posHead").innerHTML = "<tr>" + posHeaders.map(h => {
            const displayH = h.toLowerCase().startsWith('pos') ? h.replace(/pos/i, 'P') : (h === namaKey ? 'Nama' : (h === unitKey ? 'Unit' : h));
            return `<th>${displayH}</th>`;
        }).join("") + "</tr>";

        document.getElementById("posBody").innerHTML = posRows.map((r, rowIdx) => {
            let rowHtml = "<tr>";
            
            // Ambil nilai numerik dari kolom POS saja
            const numericValues = posOnlyHeaders.map(h => {
                const val = parseFloat(String(r[h]).replace(',', '.'));
                return isNaN(val) ? null : val;
            });

            const availableNums = numericValues.filter(v => v !== null);
            const max = availableNums.length ? Math.max(...availableNums) : null;
            
            posHeaders.forEach((h, i) => {
                const cell = r[h];
                let className = "";
                let display = cell;

                // Jika kolom POS
                if (posOnlyHeaders.includes(h)) {
                    const posIndex = posOnlyHeaders.indexOf(h);
                    const numVal = numericValues[posIndex];
                    if (numVal !== null) {
                        display = Number.isInteger(numVal) ? numVal : numVal.toFixed(2);
                        if (max !== null && numVal === max && numVal > 0) {
                            className = "pos-value pos-max";
                        } else if (numVal !== null) {
                             className = "pos-value pos-min"; 
                        }
                    } else {
                        className = "";
                    }
                } else {
                    // Kolom Nama/Unit
                    display = cell || '-';
                    className = '';
                }

                rowHtml += `<td class="${className}">${display}</td>`;
            });
            rowHtml += "</tr>";
            return rowHtml;
        }).join("");
    } else {
        document.getElementById("posSection").style.display = "none";
        document.getElementById("statProsentase").innerText = `0%`;
        document.getElementById("statProsentase").className = `statProsentase statProsentase-red`;
    }

    // Unit Recap - Logic
    const unitMap = {};
    data.forEach(r => {
        const u = r[unitKey];
        const v = parseFloat(r[jumlahKey]) || 0;
        if (!u) return;
        
        // SINTAKS DIPERBAIKI (MENGHILANGKAN WARNA MERAH DI VS CODE)
        if (!unitMap[u]) {
             unitMap[u] = [];
        }
        unitMap[u].push(v);
        // END PERBAIKAN SINTAKS
    });
    
    renderUnitBars(unitMap);
    
    // Tambahkan indikator waktu refresh
    const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById("unitRecapTitle").innerHTML = `Rerata Nilai Unit<span> (Terakhir: ${now})</span>`;
}


function renderUnitBars(unitMap){ 
    // ... (Fungsi renderUnitBars tidak diubah)
    const container = document.getElementById("unitBarContainer");
    container.innerHTML = "";
    const unitAvgs = Object.entries(unitMap)
      .map(([unit, values]) => ({
        unit,
        avg: values.length ? (values.reduce((a, b) => a + b, 0) / values.length) : 0,
        count: values.length
      }))
      .filter(u => u.avg > 0)
      .sort((a, b) => b.avg - a.avg)
      .slice(0, 10); // Ambil Top 10

    if (unitAvgs.length === 0) {
      container.innerHTML = `<p style="text-align:center;color:#6b7280;font-size:0.8rem;padding:10px;">Data unit tidak tersedia.</p>`;
      return;
    }

    const maxAvg = unitAvgs[0].avg;
    
    unitAvgs.forEach((item, index) => {
        const percentage = (item.avg / maxAvg) * 100;
        const color = softColors[index % softColors.length];
        const barItem = document.createElement('div');
        barItem.className = 'bar-item';
        barItem.innerHTML = `
            <div class="bar-fill" style="width: ${percentage}%; background: ${color}; --bar-color: ${color};"></div>
            <div class="bar-label">
                <span>${item.unit} (${item.count} peserta)</span>
                <span>${item.avg.toFixed(1)}</span>
            </div>
        `;
        container.appendChild(barItem);
    });
}
// --- Akhir dari fungsi renderUnitBars ---


document.addEventListener('DOMContentLoaded', async function() {
    // üì¢ DEBUG 3: Konfirmasi DOMContentLoaded terpicu
    console.log("[DEBUG 3] DOMContentLoaded: Event listener onchange sedang dipasang...");
    
    const jenisRekap = document.getElementById("jenisRekap");
    
    // Set up timer for refresh (if needed, but keeping the structure)
    // clearInterval(refreshTimer);
    // refreshTimer = setInterval(() => loadData(jenisRekap.value), 30000); // Refresh every 30 seconds

    // Initial load
    jenisRekap.onchange = (e) => {
        // üì¢ DEBUG 4: Konfirmasi onchange terpicu saat dropdown diganti
        console.log(`[DEBUG 4] Dropdown onchange terpicu. Nilai: ${e.target.value}`);
        loadData(e.target.value);
    };
    
    loadData(jenisRekap.value); 
    
    // Mobile menu toggle logic
    const toggle = document.querySelector("#menuToggle");
    const submenu = document.querySelector("#mobileSubmenu");
    const mobileHeader = document.querySelector("#mobileHeader");

    const hideMobileElements = () => {
        const isMobile = window.innerWidth <= 768;
        const sidebar = document.querySelector('.sidebar');

        if (isMobile) {
            // Logic for mobile view
        } else {
            // Desktop View
        }
    };
    
    // Logic to fix the header button visibility based on sidebar's state
    const updateHeaderVisibility = () => {
        const isMobile = window.innerWidth <= 768;
        const sidebar = document.querySelector('.sidebar');
        
        if (!isMobile) return;

        // Check if sidebar is visibly open in mobile mode (via static or transform:0)
        const isSidebarOpen = sidebar && (sidebar.style.position === 'static' || sidebar.style.transform === 'translateX(0px)');

        if (isSidebarOpen) {
            // Sidebar is open -> hide mobile header
            if (mobileHeader) { mobileHeader.style.display = 'none'; mobileHeader.style.visibility = 'hidden'; }
        } else {
            // Sidebar is closed -> show mobile header
            if (mobileHeader) { mobileHeader.style.display = 'flex'; mobileHeader.style.visibility = 'visible'; }
        }
    }


    if (toggle && submenu) {
      if (!toggle._mps_toggle_bound) {
        toggle.addEventListener("click", function(e){
          e.stopPropagation();
          submenu.classList.toggle("show");
          submenu.style.display = submenu.classList.contains('show') ? 'block' : 'none';
        });
        document.addEventListener("click", (ev) => {
          if (!submenu.contains(ev.target) && ev.target !== toggle) {
            submenu.classList.remove("show");
            submenu.style.display = 'none';
          }
        });
        toggle._mps_toggle_bound = true;
      }
    }

    hideMobileElements();

    window.addEventListener('resize', hideMobileElements);
    window.addEventListener('orientationchange', hideMobileElements);

    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      const mo = new MutationObserver(muts => {
        for (const m of muts) {
          if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')) {
            setTimeout(() => { hideMobileElements(); updateHeaderVisibility(); }, 50);
            break;
          }
        }
      });
      mo.observe(sidebar, { attributes: true, attributeFilter: ['style', 'class'] });
    }

    setTimeout(() => { hideMobileElements(); updateHeaderVisibility(); }, 300);
});

// Tambahkan event listener untuk tombol Nilai Individu jika belum ada
document.addEventListener('DOMContentLoaded', () => {
    const btnTampilkanNilai = document.getElementById('btnTampilkanNilai');
    if (btnTampilkanNilai) {
        btnTampilkanNilai.addEventListener('click', () => {
            // Karena fungsi renderNilaiIndividu sudah dipanggil, logic klik tombol sudah ada di dalamnya.
            // Cukup tambahkan efek 3D di DOMContentLoaded juga untuk memastikan saat load pertama
            // (Meskipun sudah ada di dalam renderNilaiIndividu, ini untuk fallback/redundansi)
            btnTampilkanNilai.style.transform = 'translateY(2px)';
            btnTampilkanNilai.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.2)';
            setTimeout(() => {
                btnTampilkanNilai.style.transform = 'translateY(0)';
                btnTampilkanNilai.style.boxShadow = '0 4px 0 rgba(0, 0, 0, 0.2)';
            }, 100);
        });
    }
});
</script>
</body>
</html>
