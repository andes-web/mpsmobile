<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
/* === Seluruh CSS tetap sama dari versi FIXED POS === */
body{margin:0;font-family:'Poppins',sans-serif;background:transparent;color:#1e293b;font-size:0.85rem;}
.sidebar{position:fixed;right:0;top:0;width:280px;height:100vh;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-left:1px solid #e2e8f0;box-shadow:-6px 0 20px rgba(0,0,0,0.1);display:flex;flex-direction:column;z-index:9999;}
.sidebar header{padding:8px 6px;background:linear-gradient(90deg,#4facfe,#00f2fe);color:#fff;font-size:1.2rem;font-weight:700;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,0.15);}
.sidebar main{flex:1;overflow-y:auto;padding:6px 8px;}
.top-controls{display:flex;gap:4px;margin-bottom:4px;align-items:center;}
select{flex-grow:1.5;padding:4px;border:1px solid #93c5fd;border-radius:6px;background:#f1f5f9;font-size:0.75rem;}
.action-btns{display:flex;gap:3px;}
.action-btns button{flex:1;padding:4px 6px;font-size:0.8rem;border:none;border-radius:5px;color:#fff;font-weight:600;cursor:pointer;box-shadow:0 3px 0 rgba(0,0,0,0.2);}
.btn-pdf{background:#60a5fa;}.btn-excel{background:#4ade80;}
.statBox{display:flex;justify-content:space-between;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:1px solid #bfdbfe;border-radius:6px;padding:0px 2px;margin-bottom:4px;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.statItem{text-align:center;flex:1;padding:0 3px;}
.statItem h5{font-size:0.45rem;margin:0 0 1px 0;color:#64748b;font-weight:400;}
.statItem p{font-size:0.9rem;font-weight:800;color:#1d4ed8;margin:0;}
.statProsentase-red{color:#dc2626!important;}.statProsentase-green{color:#10b981!important;}
.tableBox{border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:4px;overflow:hidden;border:1px solid #e0e7ff;}
.tableBox table{width:100%;font-size:0.7rem;border-collapse:collapse;}
.tableBox th,.tableBox td{padding:2px 4px;text-align:center;border:none;}
.tableBox th{background:#1d4ed8;color:#fff;font-weight:600;}
.tableBox tr:nth-child(even) td{background:#f9faff;}
.tableBox tr:hover td{background:#eff6ff;}
.tableBox td:nth-child(2){text-align:left;padding-left:8px;}
footer{text-align:center;font-size:0.8rem;padding:4px;}
.unit-recap-bar{margin-top:4px;background:#fff;border:1px solid #e0e7ff;border-radius:8px;padding:6px 8px;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.bar-item{height:18px;background:#f3f4f6;border-radius:4px;position:relative;overflow:hidden;margin-bottom:3px;}
.bar-fill{height:100%;transition:width .5s ease-out;}
.bar-label{position:absolute;left:6px;right:6px;color:#1f2937;font-size:0.65rem;font-weight:600;display:flex;justify-content:space-between;}
</style>
</head>

<body>
<div class="sidebar">
<header>Rekap Nilai MPS</header>
<main>
<div class="top-controls">
  <select id="jenisRekap">
    <option value="Rekap">Rekap Individu</option>
    <option value="RekapKelompok">Rekap Kelompok</option>
    <option value="Nilai_Lain">Rekap Non Teknis</option> <!-- ‚úÖ Menu baru -->
    <option value="RekapAkhir">Rekap Akhir</option>
  </select>
  <div class="action-btns">
    <button class="btn-pdf" id="btnPDF">PDF</button>
    <button class="btn-excel" id="btnExcel">Excel</button>
  </div>
</div>

<div class="statBox">
  <div class="statItem"><h5>Peserta</h5><p id="statPeserta">0</p></div>
  <div class="statItem"><h5>Rata</h5><p id="statRata">0</p></div>
  <div class="statItem"><h5>Tinggi</h5><p id="statMax">0</p></div>
  <div class="statItem"><h5>Rendah</h5><p id="statMin">0</p></div>
  <div class="statItem"><h5>Prosentase</h5><p id="statProsentase" class="statProsentase-red">0%</p></div>
</div>

<div id="contentArea">
  <div class="tableBox">
    <table id="rekapTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
  </div>
</div>

<div class="unit-recap-bar">
  <h4 id="unitRecapTitle">Rerata Nilai Unit</h4>
  <div id="unitBarContainer"></div>
</div>
</main>
<footer>¬© 2025 Andes | MPS System</footer>
</div>

<script>
const sheetAPI="https://script.google.com/macros/s/AKfycbzQ6id-Lc0RSDYTaMQC483uBsGeBNoDO30bcEYqi8iyh5EN9EYtpdaXhF17R3VlGTFG/exec";
let latestData=[],refreshTimer=null;
const softColors=['#93c5fd','#6ee7b7','#fcd34d','#fb923c','#c4b5fd','#f97316','#34d399','#22d3ee','#f472b6','#a78bfa'];
function getRankDisplay(r){return r===1?"ü•á":r===2?"ü•à":r===3?"ü•â":r;}
async function fetchSheet(s){const r=await fetch(`${sheetAPI}?sheet=${s}`);return await r.json();}

function renderUnitBars(unitMap){
 const c=document.getElementById("unitBarContainer");c.innerHTML="";
 const unitAvgs=Object.entries(unitMap).map(([u,v])=>({unit:u,avg:(v.reduce((a,b)=>a+b,0)/v.length).toFixed(1)})).sort((a,b)=>b.avg-a.avg);
 const max=Math.max(...unitAvgs.map(u=>+u.avg));
 unitAvgs.forEach((u,i)=>{
  const color=softColors[i%softColors.length];
  const w=(u.avg/max)*100;
  c.innerHTML+=`<div class="bar-item"><div class="bar-fill" style="width:${w}%;background:${color}"></div><div class="bar-label"><span>${u.unit}</span><span>${u.avg}</span></div></div>`;
 });
}

async function loadRekap(sheet="Rekap"){
 try{
  const area=document.getElementById("contentArea");
  area.innerHTML="<p style='text-align:center;'>Memuat...</p>";

  // === REKAP NON TEKNIS ===
  if(sheet==="Nilai_Lain"){
    const data=await fetchSheet("Nilai_Lain");const h=data[0];const rows=data.slice(1);
    const nama=h.indexOf("Nama"),unit=h.indexOf("Unit"),jumlah=h.indexOf("Jumlah");
    const idxG=6,idxH=7,idxK=10,idxL=11;

    const pbb=rows.map(r=>{
      const n=r[nama]||"";const st=(+r[idxG]||0)+(+r[idxK]||0);const dn=(+r[idxH]||0)+(+r[idxL]||0);return {nama:n,st:st,dn:dn,jml:st+dn};
    }).filter(r=>r.nama);
    const top5=pbb.sort((a,b)=>b.jml-a.jml).slice(0,5);

    const pbbHTML=`<div class="tableBox"><table><thead><tr><th colspan="5" style="background:#0284c7;color:#fff;">Anggota Dengan PBB Terbaik</th></tr><tr><th>üèÖ</th><th>Nama</th><th>PBB Statis</th><th>PBB Dinamis</th><th>JML</th></tr></thead><tbody>${top5.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r.nama}</td><td>${r.st}</td><td>${r.dn}</td><td><b>${r.jml}</b></td></tr>`).join("")}</tbody></table></div>`;

    const sorted=rows.sort((a,b)=>Number(b[jumlah]||0)-Number(a[jumlah]||0));
    const topRows=sorted.slice(0,50);
    const rekapHTML=`<div class="tableBox"><table><thead><tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr></thead><tbody>${topRows.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r[nama]}</td><td>${r[unit]}</td><td>${r[jumlah]}</td></tr>`).join("")}</tbody></table></div>`;

    area.innerHTML=pbbHTML+rekapHTML;
    document.querySelector(".statBox").style.display="none";
    document.querySelector(".unit-recap-bar").style.display="none";
    return;
  }

  // === REKAP AKHIR ===
  if(sheet==="RekapAkhir"){
    const d=await fetchSheet("RekapAkhir");const rows=d.slice(1).map(r=>({n:r[0],ni:+r[1]||0,nk:+r[2]||0,nn:+r[3]||0,na:+r[4]||0})).sort((a,b)=>b.na-a.na);
    const top=rows.slice(0,100);
    area.innerHTML=`<div class="tableBox"><table><thead><tr><th>üèÖ</th><th>Nama</th><th>NI</th><th>NK</th><th>NN</th><th>NA</th></tr></thead><tbody>${top.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r.n}</td><td>${r.ni}</td><td>${r.nk}</td><td>${r.nn}</td><td>${r.na}</td></tr>`).join("")}</tbody></table></div>`;
    document.querySelector(".statBox").style.display="none";
    document.querySelector(".unit-recap-bar").style.display="none";
    return;
  }

  // === REKAP INDIVIDU / KELOMPOK ===
  const d=await fetchSheet(sheet);latestData=d;const h=d[0];const rows=d.slice(1);
  const nama=h.indexOf("Nama"),unit=h.indexOf("Unit"),jumlah=h.indexOf("Jumlah");
  const sorted=rows.sort((a,b)=>Number(b[jumlah]||0)-Number(a[jumlah]||0)).slice(0,10);
  area.innerHTML=`<div class="tableBox"><table><thead><tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jml</th></tr></thead><tbody>${sorted.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r[nama]}</td><td>${r[unit]}</td><td>${r[jumlah]}</td></tr>`).join("")}</tbody></table></div>`;

  const vals=rows.map(r=>parseFloat(r[jumlah])||0).filter(v=>v>0);
  document.getElementById("statPeserta").innerText=vals.length;
  document.getElementById("statRata").innerText=(vals.reduce((a,b)=>a+b,0)/vals.length||0).toFixed(1);
  document.getElementById("statMax").innerText=Math.max(...vals);
  document.getElementById("statMin").innerText=Math.min(...vals);

  const unitMap={};rows.forEach(r=>{const u=r[unit];const v=parseFloat(r[jumlah])||0;if(!u)return;(unitMap[u]??=[]).push(v);});
  renderUnitBars(unitMap);
  document.querySelector(".statBox").style.display="";
  document.querySelector(".unit-recap-bar").style.display="";
 }catch(e){console.error(e);}
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();
if(refreshTimer)clearInterval(refreshTimer);
refreshTimer=setInterval(()=>{const v=document.getElementById("jenisRekap").value;loadRekap(v);},10000);
document.getElementById("btnExcel").addEventListener("click",()=>{const ws=XLSX.utils.aoa_to_sheet(latestData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Rekap");XLSX.writeFile(wb,"Rekap_MPS.xlsx");});
document.getElementById("btnPDF").addEventListener("click",()=>{const {jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});doc.text("Rekap Nilai MPS",220,40);doc.autoTable({html:"#rekapTable",startY:60});doc.save("Rekap_MPS.pdf");});
</script>
</body>
</html>
