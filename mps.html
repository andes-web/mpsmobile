<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sistem Penilaian Bintal Individu</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
  --accent:#2563eb;
  --danger:#dc2626;
  --success:#16a34a;
  --soft-blue:#eef4ff;
  --soft-yellow:#fffbeb;
  --school:#2563eb;
  --family:#16a34a;
  --social:#7c3aed;
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body{
  margin:0;
  padding:10px;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background:linear-gradient(135deg,#e0f2fe,#fef9c3);
  min-height:100vh;
}

/* Optimasi Tampilan Cetak PDF */
@media print {
  body { background: white !important; padding: 0; }
  .action-bar, .bar-penilaian, .top-container select, .instruction { display: none !important; }
  .container { box-shadow: none !important; border: none !important; max-width: 100% !important; width: 100% !important; }
  .aspek-card { break-inside: avoid; border: 1px solid #eee !important; margin-bottom: 5px; page-break-inside: avoid; }
  h2 { color: black !important; font-size: 1.6rem; }
  .nilai-besar.filled { opacity: 1 !important; -webkit-print-color-adjust: exact; }
}

.container{
  width:100%;
  max-width:720px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  padding:15px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}

h2{ text-align:center; margin:5px 0 15px; color: var(--accent); font-weight:900; }

.top-container{
  background:var(--soft-blue);
  border:1px solid #dbeafe;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}

.form-left{ display:flex; flex-direction:column; gap:8px; }

select, input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #c7d2fe;
  font-size:0.9rem;
  outline: none;
}

select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px #dbeafe; }

.bar-penilaian{
  background:var(--soft-yellow);
  border:1px solid #fde68a;
  border-radius:12px;
  padding:10px;
  display:flex;
  gap:8px;
  margin-bottom:10px;
}

.bar-penilaian select{ flex:1; font-weight: bold; color: #92400e; }

.rubrik{ display:grid; gap:10px; }

.aspek-card{
  background:#fff;
  border: 1px solid #f1f5f9;
  border-radius:14px;
  padding:12px;
  display:flex;
  gap:10px;
  transition: transform 0.2s;
}

.left{ flex:1; min-width:0; }
.aspek-title{ font-weight:800; font-size:0.95rem; color: #1e293b; margin-bottom: 4px; }
.indikator{ font-size:0.65rem; line-height:1.4; color: #64748b; margin-bottom: 8px; font-style: italic; }

.nilai-buttons{ display:flex; gap:5px; flex-wrap:nowrap; }
.nilai-buttons button{
  flex: 1;
  padding:8px 0;
  border-radius:8px;
  border:1px solid #e2e8f0;
  background:#f8fafc;
  font-weight:bold; 
  font-size:0.85rem; 
  cursor:pointer;
}

.nilai-buttons button.active{ 
  background: var(--accent); 
  color:#fff; 
  border-color: var(--accent);
  box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
}

.nilai-besar-stack{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  justify-content:center;
  gap:2px;
  min-width:45px;
  border-left: 1px dashed #e2e8f0;
  padding-left: 10px;
}

.nilai-besar{ font-size:1.4rem; font-weight:900; opacity:0.1; line-height:1; }
.nilai-besar.filled{ opacity:1 }
[id^="sekolah-"].filled{ color:var(--school) }
[id^="keluarga-"].filled{ color:var(--family) }
[id^="sosial-"].filled{ color:var(--social) }

.action-bar{ margin-top:20px; display:flex; gap:8px; flex-wrap: wrap; }
.action-bar button{
  flex:1; padding:12px; border-radius:10px; font-weight:800;
  font-size:0.85rem; border:none; cursor:pointer; 
  transition: opacity 0.2s;
  min-width: 140px;
}

.btn-submit{ background:var(--accent); color:#fff; }
.btn-print{ background:var(--success); color:#fff; }
.btn-reset{ background:var(--danger); color:#fff; }
button:active { opacity: 0.8; }

.autobox{
  position:absolute; background:#fff; border:1px solid #c7d2fe;
  border-radius:8px; max-height:200px; overflow-y:auto; z-index:9999;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
.autobox div{ padding:10px; font-size:0.9rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
.autobox div:last-child { border: none; }
.autobox div:hover{ background:#f0f7ff; color: var(--accent); }
</style>
</head>

<body>
<div class="container">
  <h2>NILAI BINTAL INDIVIDU</h2>

  <div class="bar-penilaian">
    <select id="pos">
      <option value="1">POS 1: Kecerdasan Emosional</option>
      <option value="2">POS 2: Ketahanan Mental</option>
      <option value="3">POS 3: Kognitif & Keputusan</option>
      <option value="4">POS 4: Integritas & Etika</option>
      <option value="5">POS 5: Motivasi & Ketegasan</option>
    </select>
    <select id="domain">
      <option value="sekolah">Domain: Sekolah</option>
      <option value="keluarga">Domain: Keluarga</option>
      <option value="sosial">Domain: Sosial</option>
    </select>
  </div>

  <div class="top-container">
    <div class="form-left">
      <select id="anggota"><option value="">-- Pilih Unit Terlebih Dahulu --</option></select>
      <input id="nama" placeholder="Ketik Nama Anggota..." autocomplete="off">
    </div>
  </div>

  <div id="rubrik-body" class="rubrik"></div>

  <div class="action-bar">
    <button class="btn-submit" onclick="submitData()">SUBMIT DATA</button>
    <button class="btn-print" onclick="window.print()">CETAK PDF</button>
    <button class="btn-reset" onclick="resetForm()">RESET FORM</button>
  </div>
</div>

<script>
// =======================================================
// ðŸ”¹ KONFIGURASI (WAJIB DIISI)
// =======================================================
const scriptURL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec"; 
const pesertaURL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec?sheet=peserta";

let dataPeserta = {};
let nilaiData = {}; // Global state untuk menyimpan nilai semua aspek
const unitSelect = document.getElementById("anggota");
const namaInput = document.getElementById("nama");
const autoBox = document.createElement("div");
autoBox.className = "autobox";
autoBox.style.display = "none";
document.body.appendChild(autoBox);

const rubrik={
  1:[{a:"Kesadaran Diri",d:["Tidak mengenali","Jarang","Cukup","Mengelola","Sangat reflektif"]},{a:"Pengendalian Diri",d:["Tidak terkendali","Lepas","Cukup","Stabil","Disiplin"]},{a:"Empati",d:["Tidak peduli","Kurang","Cukup","Tinggi","Teladan"]},{a:"Keterampilan Sosial",d:["Sulit","Terbatas","Cukup","Aktif","Pemimpin"]}],
  2:[{a:"Resiliensi",d:["Mudah menyerah","Putus asa","Cukup","Tangguh","Bangkit kuat"]},{a:"Toleransi Tekanan",d:["Tidak tahan","Stres","Cukup","Tenang","Sangat stabil"]},{a:"Menghadapi Tantangan",d:["Menghindar","Ragu","Mencoba","Menyelesaikan","Mencari tantangan"]}],
  3:[{a:"Berpikir Kritis",d:["Tidak analitis","Lemah","Cukup","Analitis","Sangat tajam"]},{a:"Pemecahan Masalah",d:["Tidak mampu","Salah","Sederhana","Tepat","Kreatif"]},{a:"Fleksibilitas Berpikir",d:["Kaku","Sulit","Cukup","Adaptif","Sangat fleksibel"]}],
  4:[{a:"Kejujuran",d:["Tidak jujur","Kadang","Cukup","Konsisten","Teladan"]},{a:"Tanggung Jawab",d:["Lalai","Kurang","Cukup","Bertanggung jawab","Sangat dipercaya"]},{a:"Kepedulian",d:["Tidak peduli","Kurang","Cukup","Aktif","Penggerak"]}],
  5:[{a:"Motivasi Diri",d:["Tidak termotivasi","Rendah","Cukup","Tinggi","Inspiratif"]},{a:"Ketekunan",d:["Mudah menyerah","Kurang","Cukup","Tekun","Pantang menyerah"]},{a:"Ketegasan Keputusan",d:["Takut","Ragu","Cukup tegas","Tegas","Pemimpin"]}]
};

// =======================================================
// ðŸ”¹ LOGIKA FORM
// =======================================================

async function loadPeserta(){
  try {
    const res = await fetch(pesertaURL);
    const data = await res.json();
    data[0].forEach((h,i) => {
      if(h){
        const o = document.createElement("option");
        o.value = h; o.textContent = h;
        unitSelect.appendChild(o);
        dataPeserta[h] = data.slice(1).map(r => r[i]).filter(Boolean);
      }
    });
  } catch(e) { console.error("Gagal load data peserta"); }
}

function render(){
  const p = document.getElementById("pos").value;
  const dom = document.getElementById("domain").value;
  const rubrikBody = document.getElementById("rubrik-body");
  rubrikBody.innerHTML = "";
  
  rubrik[p].forEach((x, i) => {
    // Inisialisasi jika data belum ada
    nilaiData[p] = nilaiData[p] || {};
    nilaiData[p][i] = nilaiData[p][i] || { sekolah: null, keluarga: null, sosial: null };

    const c = document.createElement("div");
    c.className = "aspek-card";
    c.innerHTML = `
      <div class="left">
        <div class="aspek-title">${x.a}</div>
        <div class="indikator">Skala: 1 (${x.d[0]}) s/d 5 (${x.d[4]})</div>
        <div class="nilai-buttons">
          ${[1,2,3,4,5].map(n => `
            <button type="button" 
              onclick="setNilai(${p},${i},${n},this)" 
              class="${nilaiData[p][i][dom] === n ? 'active' : ''}">
              ${n}
            </button>`).join("")}
        </div>
      </div>
      <div class="nilai-besar-stack">
        <div title="Sekolah" id="sekolah-${p}-${i}" class="nilai-besar ${nilaiData[p][i].sekolah ? 'filled' : ''}">${nilaiData[p][i].sekolah || '-'}</div>
        <div title="Keluarga" id="keluarga-${p}-${i}" class="nilai-besar ${nilaiData[p][i].keluarga ? 'filled' : ''}">${nilaiData[p][i].keluarga || '-'}</div>
        <div title="Sosial" id="sosial-${p}-${i}" class="nilai-besar ${nilaiData[p][i].sosial ? 'filled' : ''}">${nilaiData[p][i].sosial || '-'}</div>
      </div>`;
    rubrikBody.appendChild(c);
  });
}

function setNilai(p, i, n, btn){
  const dom = document.getElementById("domain").value;
  nilaiData[p][i][dom] = n;
  
  const el = document.getElementById(`${dom}-${p}-${i}`);
  el.textContent = n;
  el.classList.add("filled");
  
  btn.parentElement.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

// =======================================================
// ðŸ”¹ PROSES SUBMIT (SINKRON DENGAN APPS SCRIPT ANDA)
// =======================================================

async function submitData() {
  const unitVal = document.getElementById("anggota").value;
  const namaVal = document.getElementById("nama").value;

  if (!unitVal || !namaVal) {
    Swal.fire("Gagal", "Nama dan Unit harus diisi!", "error");
    return;
  }

  const aspekKirim = [];

  // Loop melalui kategori (rubrik)
  for (let p in nilaiData) {
    // Loop melalui sub-aspek (misal: Kesadaran Diri, Resiliensi, dll)
    for (let i in nilaiData[p]) {
      const d = nilaiData[p][i];
      
      // Ambil nilai dari 3 domain
      const vSekolah = d.sekolah;
      const vKeluarga = d.keluarga;
      const vSosial = d.sosial;

      // Filter hanya domain yang sudah diisi (tidak null)
      const values = [vSekolah, vKeluarga, vSosial].filter(v => v !== null);

      if (values.length > 0) {
        // Hitung rata-rata dari domain yang terisi
        const total = values.reduce((a, b) => a + b, 0);
        const rataRata = total / values.length;

        // Ambil nama aspek dari rubrik asli
        const namaAspek = rubrik[p][i].a;

        aspekKirim.push({
          aspek: namaAspek,
          nilai: rataRata.toFixed(2) // Simpan dengan 2 angka di belakang koma
        });
      }
    }
  }

  if (aspekKirim.length === 0) {
    Swal.fire("Peringatan", "Belum ada nilai yang diinput!", "warning");
    return;
  }

  // Siapkan Payload untuk dikirim
  const payload = {
    form: "bintal_individu",
    nama: namaVal,
    unit: unitVal,
    nilai: aspekKirim
  };

  Swal.fire({
    title: 'Menyimpan Data...',
    html: 'Mohon tunggu sebentar',
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading(); }
  });

  // Ganti scriptURL dengan URL Web App Anda yang baru
  const scriptURL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec"; 

  const formData = new URLSearchParams();
  formData.append("data", JSON.stringify(payload));

  try {
    const response = await fetch(scriptURL, {
      method: 'POST',
      body: formData,
      mode: 'no-cors'
    });
    
    Swal.fire({
      icon: 'success',
      title: 'Berhasil!',
      text: 'Data telah disimpan ke Nilai_Bintal_Individu dan Rekap Akhir',
      confirmButtonText: 'OK'
    }).then(() => {
      // Opsi: reset form setelah sukses
      // location.reload(); 
    });
  } catch (error) {
    console.error('Error:', error);
    Swal.fire("Gagal", "Terjadi kesalahan koneksi atau Script Error", "error");
  }
}
// =======================================================
// ðŸ”¹ FUNGSI PENDUKUNG (UI)
// =======================================================

unitSelect.onchange = () => { namaInput.value = ""; autoBox.style.display = "none"; };

namaInput.oninput = () => {
  const u = unitSelect.value;
  if(!u || !dataPeserta[u]) return;
  const val = namaInput.value.toLowerCase();
  const filtered = dataPeserta[u].filter(n => n.toLowerCase().includes(val));
  
  autoBox.innerHTML = "";
  if(filtered.length && val){
    filtered.forEach(n => {
      const d = document.createElement("div");
      d.textContent = n;
      d.onclick = () => { namaInput.value = n; autoBox.style.display = "none"; };
      autoBox.appendChild(d);
    });
    const r = namaInput.getBoundingClientRect();
    autoBox.style.left = r.left + "px";
    autoBox.style.top = (r.bottom + window.scrollY) + "px";
    autoBox.style.width = r.width + "px";
    autoBox.style.display = "block";
  } else { autoBox.style.display = "none"; }
};

function resetForm(){
  Swal.fire({
    title: "Reset Form?",
    text: "Semua inputan nilai yang belum disimpan akan hilang!",
    icon: "warning",
    showCancelButton: true
  }).then(r => { if(r.isConfirmed) location.reload(); });
}

document.getElementById("pos").onchange = render;
document.getElementById("domain").onchange = render;
document.addEventListener("DOMContentLoaded", () => {
  loadPeserta();
  render();
});

// Tutup autobox jika klik di luar
document.addEventListener("click", (e) => {
  if(e.target !== namaInput) autoBox.style.display = "none";
});
</script>
</body>
</html>
