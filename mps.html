<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#fff;color:#1e293b;font-size:0.85rem;}
.sidebar{position:fixed;right:0;top:0;width:280px;height:100vh;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);
border-left:1px solid #e2e8f0;box-shadow:-6px 0 20px rgba(0,0,0,0.1);display:flex;flex-direction:column;z-index:9999;}
.sidebar header{padding:8px 6px;background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:#fff;font-size:1.3rem;font-weight:700;text-align:center;}
.sidebar main{flex:1;overflow-y:auto;padding:8px;}
.top-controls{display:flex;gap:4px;margin-bottom:6px;align-items:center;}
select{flex-grow:1;padding:4px;border:1px solid #93c5fd;border-radius:6px;background:#f1f5f9;font-size:0.75rem;}
.action-btns{display:flex;gap:3px;}
.action-btns button{flex:1;padding:4px 6px;font-size:0.8rem;border:none;border-radius:5px;color:#fff;font-weight:600;cursor:pointer;
box-shadow:0 3px 0 rgba(0,0,0,0.2);}
.btn-pdf{background:#60a5fa;}.btn-excel{background:#4ade80;}
.tableBox{border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,0.08);margin-bottom:8px;overflow:hidden;border:1px solid #e0e7ff;}
.tableBox table{width:100%;font-size:0.7rem;border-collapse:collapse;}
.tableBox th,.tableBox td{padding:3px 4px;text-align:center;border:none;}
.tableBox th{background:#1d4ed8;color:#fff;font-weight:600;}
.tableBox td:nth-child(2){text-align:left;padding-left:8px;}
.tableBox tr:nth-child(even){background:#f9faff;}
.tableBox tr:hover td{background:#eff6ff;}
footer{text-align:center;padding:5px;font-size:0.75rem;}
</style>
</head>

<body>
<div class="sidebar">
  <header>Rekap Nilai MPS</header>
  <main>
    <div class="top-controls">
      <select id="jenisRekap">
        <option value="Rekap">Rekap Individu</option>
        <option value="RekapKelompok">Rekap Kelompok</option>
        <option value="Nilai_Lain">Rekap Non Teknis</option> <!-- ‚úÖ Tambahan baru -->
        <option value="RekapAkhir">Rekap Akhir</option>
      </select>
      <div class="action-btns">
        <button class="btn-pdf" id="btnPDF">PDF</button>
        <button class="btn-excel" id="btnExcel">Excel</button>
      </div>
    </div>

    <div id="contentArea"></div>
  </main>
  <footer>¬© 2025 Andes | MPS System</footer>
</div>

<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbzQ6id-Lc0RSDYTaMQC483uBsGeBNoDO30bcEYqi8iyh5EN9EYtpdaXhF17R3VlGTFG/exec";
let latestData=[],refreshTimer=null;
function getRankDisplay(r){return r===1?"ü•á":r===2?"ü•à":r===3?"ü•â":r;}
async function fetchSheet(s){const r=await fetch(`${sheetAPI}?sheet=${s}`);return await r.json();}

async function loadRekap(sheetName="Rekap"){
 try{
  const container=document.getElementById("contentArea");
  container.innerHTML=`<p style="text-align:center;">Memuat data...</p>`;

  // === MODE REKAP AKHIR ===
  if(sheetName==="RekapAkhir"){
    const dataA=await fetchSheet("RekapAkhir");
    const rows=dataA.slice(1).map(r=>({nama:r[0],ni:+r[1]||0,nk:+r[2]||0,nn:+r[3]||0,na:+r[4]||0})).sort((a,b)=>b.na-a.na);
    const top=rows.slice(0,100);
    container.innerHTML=`
      <div class="tableBox">
        <table id="rekapTable" class="rekap-akhir">
          <thead><tr><th>üèÖ</th><th>Nama</th><th>NI</th><th>NK</th><th>NN</th><th>NA</th></tr></thead>
          <tbody>${top.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r.nama}</td><td>${r.ni}</td><td>${r.nk}</td><td>${r.nn}</td><td>${r.na}</td></tr>`).join("")}</tbody>
        </table>
      </div>`;
    return;
  }

  // === MODE REKAP NON TEKNIS (dengan 5 PBB terbaik) ===
  if(sheetName==="Nilai_Lain"){
    const dataNT=await fetchSheet("Nilai_Lain");
    const headers=dataNT[0];const rows=dataNT.slice(1);
    const namaIdx=headers.indexOf("Nama"),unitIdx=headers.indexOf("Unit"),jumlahIdx=headers.indexOf("Jumlah");
    const idxG=6,idxH=7,idxK=10,idxL=11;

    const pbbRows=rows.map(r=>{
      const nama=r[namaIdx]||"";
      const pbbST=(+r[idxG]||0)+(+r[idxK]||0);
      const pbbDN=(+r[idxH]||0)+(+r[idxL]||0);
      const jml=pbbST+pbbDN;
      return {nama,pbbST,pbbDN,jml};
    }).filter(r=>r.nama);
    const top5=pbbRows.sort((a,b)=>b.jml-a.jml).slice(0,5);

    const pbbHTML=`
      <div class="tableBox">
        <table>
          <thead>
            <tr><th colspan="5" style="background:#dcec44;color:#fff;">Anggota Dengan PBB Terbaik</th></tr>
            <tr><th>üèÖ</th><th>Nama</th><th>PBB Statis</th><th>PBB Dinamis</th><th>Jml</th></tr>
          </thead>
          <tbody>
            ${top5.map((r,i)=>`
              <tr>
                <td>${getRankDisplay(i+1)}</td>
                <td style="text-align:left;padding-left:8px;">${r.nama}</td>
                <td>${r.pbbST}</td>
                <td>${r.pbbDN}</td>
                <td><b>${r.jml}</b></td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;

    const sorted=rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));
    const topRows=sorted.slice(0,50);
    const rekapHTML=`
      <div class="tableBox">
        <table id="rekapTable" class="rekap-akhir">
          <thead><tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr></thead>
          <tbody>
            ${topRows.map((r,i)=>`
              <tr><td>${getRankDisplay(i+1)}</td><td style="text-align:left;padding-left:8px;">${r[namaIdx]}</td><td>${r[unitIdx]}</td><td>${r[jumlahIdx]}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    container.innerHTML=pbbHTML+rekapHTML;
    return;
  }

  // === MODE BIASA (INDIVIDU / KELOMPOK) ===
  const data=await fetchSheet(sheetName);latestData=data;
  const headers=data[0],rows=data.slice(1);
  const namaIdx=headers.indexOf("Nama"),unitIdx=headers.indexOf("Unit"),jumlahIdx=headers.indexOf("Jumlah");
  const sorted=rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));
  const topRows=sorted.slice(0,10);
  container.innerHTML=`
    <div class="tableBox">
      <table id="rekapTable">
        <thead><tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jml</th></tr></thead>
        <tbody>${topRows.map((r,i)=>`<tr><td>${getRankDisplay(i+1)}</td><td>${r[namaIdx]}</td><td>${r[unitIdx]}</td><td>${r[jumlahIdx]}</td></tr>`).join("")}</tbody>
      </table>
    </div>`;
 }catch(e){console.error(e);}
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();
if(refreshTimer)clearInterval(refreshTimer);
refreshTimer=setInterval(()=>{const v=document.getElementById("jenisRekap").value;loadRekap(v);},10000);

document.getElementById("btnExcel").addEventListener("click",()=>{const ws=XLSX.utils.aoa_to_sheet(latestData);const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Rekap");XLSX.writeFile(wb,"Rekap_MPS.xlsx");});
document.getElementById("btnPDF").addEventListener("click",()=>{const {jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});
doc.text("Rekap Nilai MPS",220,40);doc.autoTable({html:"#rekapTable",startY:60});doc.save("Rekap_MPS.pdf");});
</script>
</body>
</html>
