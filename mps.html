<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Presensi Mobile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    :root { 
      --primary-green: #2d6a4f; 
      --soft-green: #f0f7f2; 
      --header-green: #1b4332; 
    }
    
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--soft-green); }

    body { display: flex; flex-direction: column; height: 100dvh; }

    /* Header Identitas - Proporsional */
    .header-fixed {
      flex-shrink: 0;
      background-color: #ffffff;
      padding: 12px 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
    }

    .filter-row { display: flex; gap: 4px; width: 100%; }
    /* Penyesuaian Lebar agar Floating Label tetap cantik */
    .filter-row .form-floating:nth-child(1) { flex: 2; } /* Unit */
    .filter-row .form-floating:nth-child(2) { flex: 1.1; } /* Kegiatan */
    .filter-row .form-floating:nth-child(3) { flex: 1.1; } /* Tanggal */

    .form-floating > .form-select, .form-floating > .form-control {
      font-size: 11px !important; height: 48px !important; border-radius: 10px !important;
      border: 1px solid #ced4da;
    }

    .form-floating > label { font-size: 9px !important; padding: 10px 8px !important; }

    /* Area Tengah - Scrollable */
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 0 10px 10px 10px;
      -webkit-overflow-scrolling: touch;
      position: relative; /* Tambahkan ini */
    }

    /* Tabel Halus */
    .table-wrapper { 
      background: white; 
      border-radius: 12px !important;  
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .table { margin: 0; width: 100%; border-collapse: collapse !important; }
    
    .table thead th {
  position: -webkit-sticky; /* Dukungan Safari */
  position: sticky; 
  top: 0;
  background-color: var(--header-green) !important;
  color: white !important;
  z-index: 1000; /* Pastikan di atas konten body tabel */
  font-size: 12px;
  text-align: center;
  padding: 8px 5px !important;
  border: none;
  text-transform: uppercase;
  /* Tambahkan box-shadow halus agar header tidak terlihat tembus saat scroll */
  box-shadow: 0 2px 2px rgba(0,0,0,0.1); 
}

    .table td { 
      padding: 4px 6px !important; 
      font-size: 12.5px; 
      border-bottom: 1px solid #f5f5f5;
      background: white;
      line-height: 1.2; /* Mengatur jarak antar baris teks */
      vertical-align: middle; /* Memastikan konten tetap di tengah secara vertikal */
    }

    /* Footer Statis Permanen */
    .footer-action {
      flex-shrink: 0;
      background: white; 
      padding: 15px; 
      border-top: 1px solid #eee;
      display: flex; 
      gap: 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
    }

    .btn-home, .btn-save { 
      flex: 1; border-radius: 12px; padding: 14px; 
      font-weight: bold; border: none; font-size: 14px; 
      text-align: center; text-decoration: none;
    }

    .btn-home { background-color: var(--primary-green); color: white; border: 1px solid #ddd; }
    .btn-save { background-color: var(--primary-green); color: white; }

    /* Styling Logo & Status */
    .unit-logo { height: 26px; width: auto; max-width: 65px; object-fit: contain; display: block; margin: 0 auto; }
    .status-select { border-radius: 6px !important; font-size: 11px !important; height: 30px !important; padding: 0 4px !important; background-color: #f9f9f9; }

    /* Swal Positioning Fix */
    .swal2-container { z-index: 99999 !important; }
    .swal2-popup { border-radius: 20px !important; padding: 1.2rem !important; }

    /* Media Query khusus untuk layar HP */
@media (max-width: 768px) {
  
  /* 1. Paksa padding sel tabel sekecil mungkin */
  .table td { 
    padding: 2px 4px !important; 
    line-height: 1 !important;
    height: 32px; /* Mengunci tinggi baris agar konsisten */
  }

  /* 2. Perkecil padding header agar tidak memakan ruang layar */
  .table thead th {
    padding: 6px 2px !important;
    font-size: 12px !important;
  }

  /* 3. Paksa tinggi select status menjadi sangat ramping */
  .status-select {
    height: 24px !important;
    padding: 0 2px !important;
    font-size: 12px !important;
    margin: 0 !important;
  }

  /* 4. Sesuaikan ukuran teks Nama agar tidak overflow */
  .table td.fw-bold {
    font-size: 12px !important;
    letter-spacing: -0.2px;
  }

  /* 5. Kecilkan logo unit lebih jauh di mobile */
  .unit-logo {
    height: 18px !important;
    max-width: 45px !important;
  }
  
  /* 1. Rampingkan Header Floating */
  .header-fixed {
    padding: 6px 4px !important; /* Kurangi padding luar header */
  }

  .filter-row {
    gap: 3px !important; /* Rapatkan jarak antar kotak input */
  }

  .form-floating > .form-select, 
  .form-floating > .form-control {
    height: 38px !important; /* Kurangi tinggi kotak input dari 48px ke 38px */
    font-size: 11px !important;
    padding-top: 10px !important; /* Sesuaikan posisi teks di dalam */
  }

  .form-floating > label {
    font-size: 8px !important; /* Kecilkan label (UNIT, KEGIATAN, TANGGAL) */
    padding: 8px 8px !important;
    transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
  }

  /* 2. Rampingkan Footer */
  .footer-action {
    padding: 8px 12px !important; /* Kurangi padding footer dari 15px ke 8px */
    gap: 8px !important;
  }

  .btn-home, .btn-save {
    padding: 8px !important; /* Kurangi ketebalan tombol */
    font-size: 12px !important; /* Kecilkan font tombol */
    border-radius: 8px !important;
  }

  /* 3. Maksimalkan Area Tabel */
  .table-container {
    padding: 4px 8px !important; /* Kurangi padding samping tabel */
  }
}
  </style>
</head>
<body>

<div class="header-fixed">
  <div class="filter-row">
    <div class="form-floating">
      <select id="filterUnit" class="form-select" onchange="renderTable()"><option value="Semua Unit">Semua</option></select>
      <label>UNIT</label>
    </div>
    <div class="form-floating">
      <select id="kegiatan" class="form-select">
        <option value="Diklat">Diklat</option>
        <option value="Bintal">Bintal</option>
        <option value="Bintur">Bintur</option>
      </select>
      <label>KEGIATAN</label>
    </div>
    <div class="form-floating">
      <input type="date" id="tanggal" class="form-control">
      <label>TANGGAL</label>
    </div>
  </div>
</div>

<div class="table-container">
  <div class="table-wrapper">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th style="width: 40px;">NO</th>
          <th>NAMA</th>
          <th style="width: 80px;">UNIT</th>
          <th style="width: 75px;">STATUS</th>
        </tr>
      </thead>
      <tbody id="tabelBody">
        <tr><td colspan="4" class="text-center p-5 text-muted">Memuat Akses...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="footer-action">
  <a href="https://andes-web.github.io/mpsmobile/" class="btn-home">üè† HOME</a>
  <button onclick="simpanKehadiran()" id="btnSimpan" class="btn-save">üíæ SIMPAN</button>
</div>

<script>
  let dataPeserta = [];
  const PASS_VALID = "@mps#";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzuZDCErpR_k3OaCwOpE24-hBQErV_PW__qEQMDvhtFqmUNRgaQQehSvaejgGiLf9I/exec";
  const BASE_URL_LOGO = "https://andes-web.github.io/mpsmobile/"; 

  const unitLogoMap = {
    "SMPN 1 Citeureup": "1_Citeureup.png", "SMPN 6 Depok": "6-removebg-preview (1).png",
    "SMPN 7 Depok": "7.png", "SMPN 8 Depok": "8-removebg-preview.png",
    "SMPN 12 Depok": "12-removebg-preview.png", "SMPN 16 Depok": "16-removebg-preview.png",
    "SMPN 31 Depok": "31-removebg-preview.png", "SMPN 32 Depok": "SMP_32.png"
  };

  window.onload = async () => {
    const { value: password } = await Swal.fire({
      title: 'Password Akses',
      input: 'password',
      inputPlaceholder: 'Masukan Password...',
      confirmButtonColor: '#2d6a4f',
      allowOutsideClick: false,
      heightAuto: false
    });

    if (password === PASS_VALID) {
      startApp();
    } else {
      Swal.fire('Gagal', 'Password Salah', 'error').then(() => window.location.reload());
    }
  };

  function startApp() {
    document.getElementById('tanggal').valueAsDate = new Date();
    fetch(GAS_URL + "?action=getListData")
      .then(res => res.json())
      .then(res => {
        if(res.success) {
          dataPeserta = res.data.pesertabintal;
          const unitSelect = document.getElementById('filterUnit');
          res.data.units.forEach(u => { unitSelect.add(new Option(u, u)); });
          renderTable();
        }
      });
  }

  function renderTable() {
    const filter = document.getElementById('filterUnit').value;
    const tbody = document.getElementById('tabelBody');
    tbody.innerHTML = "";
    const filtered = filter === "Semua Unit" ? dataPeserta : dataPeserta.filter(p => p.unit === filter);
    
    filtered.forEach((p, i) => {
      const fileName = unitLogoMap[p.unit];
      const unitDisplay = fileName 
        ? `<img src="${BASE_URL_LOGO + fileName}" class="unit-logo" onerror="this.outerHTML='<small>${p.unit.substring(0,5)}</small>'">` 
        : `<small>${p.unit.substring(0,5)}</small>`;

      tbody.innerHTML += `
        <tr>
          <td class="text-center text-muted">${i+1}</td>
          <td class="fw-bold" style="font-size:12px;">${p.nama}</td>
          <td class="text-center">${unitDisplay}</td>
          <td>
            <select class="form-select form-select-sm status-select" data-nama="${p.nama}" data-unit="${p.unit}">
              <option value="Hadir">H</option>
              <option value="Ijin">I</option>
              <option value="Sakit">S</option>
              <option value="Absen">A</option>
            </select>
          </td>
        </tr>
      `;
    });
  }

  function simpanKehadiran() {
    const tgl = document.getElementById('tanggal').value;
    if(!tgl) return Swal.fire('Oops', 'Pilih tanggal!', 'warning');
    
    Swal.fire({
      title: 'Simpan Data?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2d6a4f',
      confirmButtonText: 'Simpan Sekarang'
    }).then((result) => {
      if (result.isConfirmed) {
        const btn = document.getElementById('btnSimpan');
        btn.innerText = "SEDANG SIMPAN...";
        btn.disabled = true;

        const payload = Array.from(document.querySelectorAll('.status-select')).map(s => ({
          nama: s.dataset.nama, unit: s.dataset.unit, status: s.value,
          tanggal: tgl, kegiatan: document.getElementById('kegiatan').value
        }));

        fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: "saveKehadiran", data: payload })
        })
        .then(() => {
          Swal.fire({ title: 'Berhasil!', icon: 'success', timer: 1500, showConfirmButton: false });
          btn.innerText = "üíæ SIMPAN";
          btn.disabled = false;
        });
      }
    });
  }
</script>
</body>
</html>
