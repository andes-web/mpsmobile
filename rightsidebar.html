<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: transparent;
  color: #1e293b;
}
.sidebar {
  position: fixed;
  right: 0;
  top: 0;
  width: 280px;
  height: 100vh;
  background: rgba(255, 255, 255, 0.96);
  backdrop-filter: blur(10px);
  border-left: 1px solid #e2e8f0;
  box-shadow: -4px 0 16px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  z-index: 9999;
}
.sidebar header {
  text-align: center;
  padding: 10px 6px;
  border-bottom: 1px solid #e2e8f0;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: #fff;
  font-size: 0.95rem;
}
.sidebar main {
  flex: 1;
  overflow-y: auto;
  padding: 8px 10px;
}
select {
  width: 100%;
  padding: 5px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  background: #f9fafb;
  font-size: 0.8rem;
  margin-bottom: 8px;
  outline: none;
}
.action-btns {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
}
.action-btns button {
  flex: 1;
  padding: 5px;
  font-size: 0.7rem;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
}
.btn-pdf { background: #dc2626; }
.btn-excel { background: #16a34a; }

.statBox {
  display: flex;
  justify-content: space-around;
  background: #f1f5f9;
  border-radius: 8px;
  padding: 4px;
  margin-bottom: 8px;
}
.statItem { text-align: center; }
.statItem h5 {
  font-size: 0.6rem;
  margin: 0;
  color: #475569;
}
.statItem p {
  font-size: 0.8rem;
  font-weight: 600;
  color: #2563eb;
  margin: 0;
}

.tableBox {
  border-radius: 8px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  overflow: hidden;
  margin-bottom: 6px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
}
th, td { padding: 5px 6px; text-align: center; }
th { background: #2563eb; color: #fff; position: sticky; top: 0; }
tr:nth-child(even) td { background: #f8fafc; }

.unit-recap {
  margin-top: 10px;
  background: #f8fafc;
  border-radius: 8px;
  padding: 6px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}
.unit-recap h4 {
  margin: 0 0 4px 0;
  font-size: 0.8rem;
  color: #2563eb;
  text-align: center;
}
.unit-recap table {
  width: 100%;
  font-size: 0.7rem;
}
.chartBox {
  width: 100%;
  height: 160px;
  margin-top: 8px;
}
canvas { width: 100% !important; height: 160px !important; }
footer {
  font-size: 0.65rem;
  text-align: center;
  color: #64748b;
  border-top: 1px solid #e2e8f0;
  padding: 4px;
}
</style>
</head>

<body>
<div class="sidebar">
  <header>üìä Rekap Interaktif</header>
  <main>
    <select id="jenisRekap">
      <option value="Rekap">Rekap Individu</option>
      <option value="RekapKelompok">Rekap Kelompok</option>
      <option value="PosIndividu">Rekap Pos Individu</option>
      <option value="PosKelompok">Rekap Pos Kelompok</option>
    </select>

    <div class="action-btns">
      <button class="btn-pdf" id="btnPDF">PDF</button>
      <button class="btn-excel" id="btnExcel">Excel</button>
    </div>

    <!-- Statistik dipindah ke sini -->
    <div class="statBox">
      <div class="statItem"><h5>Peserta</h5><p id="statPeserta">0</p></div>
      <div class="statItem"><h5>Rata</h5><p id="statRata">0</p></div>
      <div class="statItem"><h5>Tinggi</h5><p id="statMax">0</p></div>
      <div class="statItem"><h5>Rendah</h5><p id="statMin">0</p></div>
    </div>

    <div class="tableBox">
      <table id="rekapTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="unit-recap">
      <h4>Rekap per Unit</h4>
      <table>
        <thead><tr><th>Unit</th><th>Rata-rata</th></tr></thead>
        <tbody id="unitBody"></tbody>
      </table>
    </div>

    <div class="chartBox">
      <canvas id="chartUnit"></canvas>
    </div>
  </main>
  <footer>¬© 2025 Andes | MPS System</footer>
</div>

<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbzQ6id-Lc0RSDYTaMQC483uBsGeBNoDO30bcEYqi8iyh5EN9EYtpdaXhF17R3VlGTFG/exec";
let chartUnit, latestData=[];

function getMedalIcon(rank){
  if(rank===1) return "ü•á";
  if(rank===2) return "ü•à";
  if(rank===3) return "ü•â";
  return rank;
}

async function loadRekap(sheetName="Rekap") {
  try {
    const res = await fetch(`${sheetAPI}?sheet=${sheetName}`);
    const data = await res.json();
    latestData = data;
    const headers = data[0];
    const rows = data.slice(1);

    const namaIdx = headers.indexOf("Nama");
    const unitIdx = headers.indexOf("Unit");
    const jumlahIdx = headers.indexOf("Jumlah");

    const sortedRows = rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));

    // Batas tampil
    let limit = rows.length;
    if(sheetName==="Rekap") limit=3;
    if(sheetName==="RekapKelompok") limit=8;
    const limitedRows = sortedRows.slice(0,limit);

    document.getElementById("tableHead").innerHTML="<tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr>";
    document.getElementById("tableBody").innerHTML=limitedRows.map((r,i)=>`
      <tr>
        <td>${getMedalIcon(i+1)}</td>
        <td>${r[namaIdx]||""}</td>
        <td>${r[unitIdx]||""}</td>
        <td>${r[jumlahIdx]||0}</td>
      </tr>`).join("");

    const jumlahArr = rows.map(r=>parseFloat(r[jumlahIdx])||0).filter(v=>v>0);
    const peserta = jumlahArr.length;
    const total = jumlahArr.reduce((a,b)=>a+b,0);
    const rata = peserta?(total/peserta).toFixed(1):0;
    const max = peserta?Math.max(...jumlahArr):0;
    const min = peserta?Math.min(...jumlahArr):0;

    document.getElementById("statPeserta").innerText=peserta;
    document.getElementById("statRata").innerText=rata;
    document.getElementById("statMax").innerText=max;
    document.getElementById("statMin").innerText=min;

    const unitMap={};
    rows.forEach(r=>{
      const unit=r[unitIdx];
      const total=parseFloat(r[jumlahIdx])||0;
      if(!unit)return;
      if(!unitMap[unit])unitMap[unit]=[];
      unitMap[unit].push(total);
    });

    const unitLabels=[],unitAverages=[];
    const unitRows=Object.entries(unitMap).map(([unit,vals])=>{
      const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
      unitLabels.push(unit);
      unitAverages.push(Number(avg));
      return `<tr><td>${unit}</td><td>${avg}</td></tr>`;
    }).join("")||"<tr><td colspan='2'>Belum ada data</td></tr>";
    document.getElementById("unitBody").innerHTML=unitRows;

    const ctx=document.getElementById("chartUnit").getContext("2d");
    if(chartUnit)chartUnit.destroy();
    chartUnit=new Chart(ctx,{
      type:"bar",
      data:{labels:unitLabels,datasets:[{data:unitAverages,backgroundColor:"rgba(37,99,235,0.7)",borderRadius:6}]},
      options:{plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:8}}},y:{beginAtZero:true,max:100}}}
    });

  } catch(err){ console.error("Gagal memuat:",err); }
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();

// Export Excel
document.getElementById("btnExcel").addEventListener("click",()=>{
  const ws=XLSX.utils.aoa_to_sheet(latestData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Rekap");
  XLSX.writeFile(wb,"Rekap_MPS.xlsx");
});

// Export PDF
document.getElementById("btnPDF").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"portrait",unit:"pt",format:"a4" });
  doc.text("Rekap Nilai MPS", 220,40);
  doc.autoTable({ html:"#rekapTable", startY:60 });
  doc.save("Rekap_MPS.pdf");
});
</script>
</body>
</html>
