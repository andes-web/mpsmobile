<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: transparent;
  color: #1e293b;
}
.sidebar {
  position: fixed;
  right: 0;
  top: 0;
  width: 280px;
  height: 100vh;
  background: rgba(255, 255, 255, 0.96);
  backdrop-filter: blur(10px);
  border-left: 1px solid #e2e8f0;
  box-shadow: -4px 0 16px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  z-index: 9999;
}
.sidebar header {
  text-align: center;
  padding: 14px 10px;
  border-bottom: 1px solid #e2e8f0;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.sidebar header h2 {
  margin: 0;
  font-size: 1.05rem;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
}
.sidebar main {
  flex: 1;
  overflow-y: auto;
  padding: 10px 14px;
}
select {
  width: 100%;
  padding: 6px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  background: #f9fafb;
  font-size: 0.9rem;
  margin-bottom: 10px;
  outline: none;
}
.action-btns {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}
.action-btns button {
  flex: 1;
  padding: 6px;
  font-size: 0.75rem;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s ease;
}
.btn-pdf { background: #dc2626; }
.btn-excel { background: #16a34a; }
.action-btns button:hover { opacity: 0.85; }
.tableBox {
  border-radius: 10px;
  background: #ffffff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  overflow: hidden;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}
th, td {
  padding: 6px 8px;
  text-align: center;
}
th {
  background: #2563eb;
  color: #fff;
  font-weight: 500;
  position: sticky;
  top: 0;
}
tr:nth-child(even) td {
  background: #f8fafc;
}
tr:hover td {
  background: #e0f2fe;
  cursor: pointer;
}
.statBox {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  background: linear-gradient(135deg, #eff6ff 0%, #f1f5f9 100%);
  border-radius: 10px;
  margin-top: 10px;
  padding: 8px 6px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}
.statItem {
  flex: 1 1 48%;
  margin: 4px 0;
  background: #fff;
  border-radius: 8px;
  text-align: center;
  padding: 6px 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.statItem h5 {
  margin: 0;
  font-size: 0.65rem;
  color: #475569;
}
.statItem p {
  margin: 2px 0 0 0;
  font-size: 0.9rem;
  font-weight: 600;
  color: #2563eb;
}
.unit-recap {
  margin-top: 15px;
  background: #f8fafc;
  border-radius: 10px;
  padding: 8px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}
.unit-recap h4 {
  margin: 0 0 6px 0;
  font-size: 0.9rem;
  color: #2563eb;
  text-align: center;
}
.unit-recap table {
  width: 100%;
  font-size: 0.75rem;
  border-collapse: collapse;
}
.unit-recap th, .unit-recap td {
  padding: 4px 6px;
  text-align: center;
}
.unit-recap th {
  background: #1d4ed8;
  color: #fff;
}
.unit-recap tr:nth-child(even) td {
  background: #f1f5f9;
}
.chartBox {
  width: 100%;
  height: 180px;
  margin-top: 12px;
}
canvas {
  width: 100% !important;
  height: 180px !important;
}
footer {
  padding: 6px;
  font-size: 0.7rem;
  text-align: center;
  color: #64748b;
  border-top: 1px solid #e2e8f0;
}
</style>
</head>

<body>
<div class="sidebar">
  <header>
    <h2><i data-lucide="bar-chart-3"></i> Rekap Interaktif</h2>
  </header>

  <main>
    <select id="jenisRekap">
      <option value="Rekap">Rekap Individu</option>
      <option value="RekapKelompok">Rekap Kelompok</option>
    </select>

    <div class="action-btns">
      <button class="btn-pdf" id="btnPDF"><i data-lucide="file-text"></i></button>
      <button class="btn-excel" id="btnExcel"><i data-lucide="file-spreadsheet"></i></button>
    </div>

    <div class="tableBox">
      <table id="rekapTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="statBox" id="statBox">
      <div class="statItem"><h5>Peserta</h5><p id="statPeserta">0</p></div>
      <div class="statItem"><h5>Rata-rata</h5><p id="statRata">0</p></div>
      <div class="statItem"><h5>Tertinggi</h5><p id="statMax">0</p></div>
      <div class="statItem"><h5>Terendah</h5><p id="statMin">0</p></div>
    </div>

    <div class="unit-recap" id="unitRecap">
      <h4>Rekap per Unit</h4>
      <table>
        <thead><tr><th>Unit</th><th>Rata-rata</th></tr></thead>
        <tbody id="unitBody"></tbody>
      </table>
    </div>

    <div class="chartBox">
      <canvas id="chartUnit"></canvas>
    </div>
  </main>

  <footer>Â© 2025 Andes | MPS System</footer>
</div>

<script>
lucide.createIcons();
const sheetAPI = "https://script.google.com/macros/s/AKfycbxsg6MM-KuZjQQawGcCYzpvdZMuQ9nwwXmxFm5V5KgNlDogs5p3tjiOef7ObOey_ApD/exec"; 
let chartUnit, latestData=[];

async function loadRekap(sheetName="Rekap") {
  try {
    const res = await fetch(`${sheetAPI}?sheet=${sheetName}`);
    const data = await res.json();
    latestData = data;
    const headers = data[0];
    const rows = data.slice(1);

    const namaIdx = headers.indexOf("Nama");
    const unitIdx = headers.indexOf("Unit");
    const jumlahIdx = headers.indexOf("Jumlah");

    document.getElementById("tableHead").innerHTML = "<tr><th>No</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr>";
    document.getElementById("tableBody").innerHTML = rows.map((r,i)=>`
      <tr data-index="${i}">
        <td>${r[0]||i+1}</td>
        <td>${r[namaIdx]||""}</td>
        <td>${r[unitIdx]||""}</td>
        <td>${r[jumlahIdx]||0}</td>
      </tr>`).join("");

    // Popup detail
    document.querySelectorAll("#rekapTable tbody tr").forEach(tr=>{
      tr.addEventListener("click",()=>{
        const idx=tr.getAttribute("data-index");
        const peserta=rows[idx];
        const nama=peserta[namaIdx];
        const unit=peserta[unitIdx];
        let html="<div style='text-align:left;font-size:0.85rem'>";
        headers.forEach((h,i)=>{
          if(["No","Nama","Unit","Jumlah"].includes(h))return;
          const val=peserta[i];
          if(val!=="" && val!=null){
            let bg="#d1fae5";if(val<=2)bg="#fee2e2";else if(val==3)bg="#fef9c3";
            html+=`<div style="display:flex;justify-content:space-between;background:${bg};
              padding:4px 6px;margin:2px 0;border-radius:6px">
              <span>${h}</span><b>${val}</b></div>`;
          }
        });
        html+="</div>";
        Swal.fire({
          title:nama,
          html:`<p><i>${unit}</i></p>${html}`,
          width:370,
          background:"#fff",
          confirmButtonColor:"#2563eb",
          showCloseButton:true,
        });
      });
    });

    // Statistik
    const jumlahArr = rows.map(r=>Number(r[jumlahIdx])).filter(v=>!isNaN(v) && v>0);
    const peserta = jumlahArr.length;
    const totalNilai = jumlahArr.reduce((a,b)=>a+b,0);
    const rata = peserta ? (totalNilai / peserta).toFixed(1) : 0;
    const max = peserta ? Math.max(...jumlahArr) : 0;
    const min = peserta ? Math.min(...jumlahArr) : 0;
    document.getElementById("statPeserta").innerText = peserta;
    document.getElementById("statRata").innerText = rata;
    document.getElementById("statMax").innerText = max;
    document.getElementById("statMin").innerText = min;

    // Rekap per Unit
    const unitMap={};
    rows.forEach(r=>{
      const unit=r[unitIdx];
      const total=Number(r[jumlahIdx]||0);
      if(!unit) return;
      if(!unitMap[unit]) unitMap[unit]=[];
      unitMap[unit].push(total);
    });
    const unitLabels=[], unitAverages=[];
    const unitRows=Object.entries(unitMap).map(([unit,vals])=>{
      const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
      unitLabels.push(unit);
      unitAverages.push(Number(avg));
      return `<tr><td>${unit}</td><td>${avg}</td></tr>`;
    }).join("") || "<tr><td colspan='2'>Belum ada data</td></tr>";
    document.getElementById("unitBody").innerHTML=unitRows;

    // Chart
    const ctx=document.getElementById("chartUnit").getContext("2d");
    if(chartUnit) chartUnit.destroy();
    chartUnit = new Chart(ctx, {
      type: "bar",
      data: {
        labels: unitLabels,
        datasets: [{
          label: "Rata-rata Nilai",
          data: unitAverages,
          borderRadius: 6,
          backgroundColor: "rgba(37,99,235,0.7)"
        }]
      },
      options: {
        plugins:{legend:{display:false}},
        scales:{
          x:{ticks:{font:{size:9}}, grid:{display:false}},
          y:{beginAtZero:true, max:100, ticks:{font:{size:8}}}
        }
      }
    });

  } catch(e){
    console.error("Gagal memuat:",e);
  }
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();

// Export Excel
document.getElementById("btnExcel").addEventListener("click",()=>{
  const ws=XLSX.utils.aoa_to_sheet(latestData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Rekap");
  XLSX.writeFile(wb,"Rekap_MPS.xlsx");
});

// Export PDF
document.getElementById("btnPDF").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  doc.text("Rekap Nilai MPS", 220, 40);
  doc.autoTable({ html: "#rekapTable", startY: 60 });
  doc.save("Rekap_MPS.pdf");
});
</script>
</body>
</html>
