<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rekap Nilai MPS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: transparent;
  color: #1e293b;
}
.sidebar {
  position: fixed;
  right: 0;
  top: 0;
  width: 280px;
  height: 100vh;
  background: rgba(255, 255, 255, 0.96);
  backdrop-filter: blur(10px);
  border-left: 1px solid #e2e8f0;
  box-shadow: -4px 0 16px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  z-index: 9999;
}
.sidebar header {
  text-align: center;
  padding: 10px 6px;
  border-bottom: 1px solid #e2e8f0;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: #fff;
  font-size: 0.95rem;
}
.sidebar main {
  flex: 1;
  overflow-y: auto;
  padding: 8px 10px;
}
select {
  width: 100%;
  padding: 5px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  background: #f9fafb;
  font-size: 0.8rem;
  margin-bottom: 8px;
  outline: none;
}
.action-btns {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
}
.action-btns button {
  flex: 1;
  padding: 5px;
  font-size: 0.7rem;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
}
.btn-pdf { background: #dc2626; }
.btn-excel { background: #16a34a; }

.statBox {
  display: flex;
  justify-content: space-around;
  background: #f1f5f9;
  border-radius: 8px;
  padding: 4px;
  margin-bottom: 8px;
}
.statItem { text-align: center; }
.statItem h5 {
  font-size: 0.6rem;
  margin: 0;
  color: #475569;
}
.statItem p {
  font-size: 0.8rem;
  font-weight: 600;
  color: #2563eb;
  margin: 0;
}

.tableBox {
  border-radius: 8px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  overflow: hidden;
  margin-bottom: 6px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
}
th, td { padding: 5px 6px; text-align: center; }
th { background: #2563eb; color: #fff; position: sticky; top: 0; }
tr:nth-child(even) td { background: #f8fafc; }

.unit-recap {
  margin-top: 10px;
  background: #f8fafc;
  border-radius: 8px;
  padding: 6px;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
}
.unit-recap h4 {
  margin: 0 0 4px 0;
  font-size: 0.8rem;
  color: #2563eb;
  text-align: center;
}
.unit-recap table {
  width: 100%;
  font-size: 0.7rem;
}
.chartBox {
  width: 100%;
  height: 160px;
  margin-top: 8px;
}
canvas { width: 100% !important; height: 160px !important; }
footer {
  font-size: 0.65rem;
  text-align: center;
  color: #64748b;
  border-top: 1px solid #e2e8f0;
  padding: 4px;
}
.posTable {
  margin-top: 6px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.posTable h4 {
  text-align: center;
  background: #1e40af;
  color: white;
  margin: 0;
  padding: 4px;
  font-size: 0.75rem;
}
.posTable th:nth-child(1) { background: #93c5fd; }
.posTable th:nth-child(2) { background: #86efac; }
.posTable th:nth-child(3) { background: #fde68a; }
.posTable th:nth-child(4) { background: #fdba74; }
.posTable th:nth-child(5) { background: #c4b5fd; }
</style>
</head>

<body>
<!-- üß≠ HEADER UTAMA -->
<header id="mobileHeader">
  <span>Rekap Interaktif</span>
  <div id="btnHome" onclick="window.location.href='https://andes-web.github.io/mpsmobile/'">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="white" viewBox="0 0 24 24">
      <path d="M12 3l9 9h-3v9h-12v-9h-3l9-9z"/>
    </svg>
  </div>
</header>

<!-- Spacer agar konten tidak ketimpa header -->
<div style="height:55px;"></div>

<div class="sidebar">
  <header>üìä Rekap Interaktif</header>
  <main>
    <select id="jenisRekap">
      <option value="Rekap">Rekap Individu</option>
      <option value="RekapKelompok">Rekap Kelompok</option>
    </select>

    <div class="action-btns">
      <button class="btn-pdf" id="btnPDF">PDF</button>
      <button class="btn-excel" id="btnExcel">Excel</button>
    </div>

    <div class="statBox">
      <div class="statItem"><h5>Peserta</h5><p id="statPeserta">0</p></div>
      <div class="statItem"><h5>Rata</h5><p id="statRata">0</p></div>
      <div class="statItem"><h5>Tinggi</h5><p id="statMax">0</p></div>
      <div class="statItem"><h5>Rendah</h5><p id="statMin">0</p></div>
    </div>

    <div class="tableBox">
      <table id="rekapTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Tabel POS tambahan -->
    <div class="posTable" id="posSection" style="display:none;">
      <h4 id="posTitle"></h4>
      <table id="posTable">
        <thead id="posHead"></thead>
        <tbody id="posBody"></tbody>
      </table>
    </div>

    <div class="unit-recap">
      <h4>Rekap per Unit</h4>
      <table>
        <thead><tr><th>Unit</th><th>Rata-rata</th></tr></thead>
        <tbody id="unitBody"></tbody>
      </table>
    </div>

    <div class="chartBox">
      <canvas id="chartUnit"></canvas>
    </div>
  </main>
  <footer>¬© 2025 Andes | MPS System</footer>
</div>
<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbzQ6id-Lc0RSDYTaMQC483uBsGeBNoDO30bcEYqi8iyh5EN9EYtpdaXhF17R3VlGTFG/exec";
let chartUnit, latestData=[], refreshTimer=null;
function getMedalIcon(rank){return rank===1?"ü•á":rank===2?"ü•à":rank===3?"ü•â":rank;}
async function fetchSheet(sheet){const res=await fetch(`${sheetAPI}?sheet=${sheet}`);return await res.json();}

async function loadRekap(sheetName="Rekap"){
 try{
  const data=await fetchSheet(sheetName);latestData=data;
  const headers=data[0],rows=data.slice(1);
  const namaIdx=headers.indexOf("Nama"),unitIdx=headers.indexOf("Unit"),jumlahIdx=headers.indexOf("Jumlah");
  const sorted=rows.sort((a,b)=>Number(b[jumlahIdx]||0)-Number(a[jumlahIdx]||0));
  const limit=sheetName==="Rekap"?3:8;const topRows=sorted.slice(0,limit);
  document.getElementById("tableHead").innerHTML="<tr><th>üèÖ</th><th>Nama</th><th>Unit</th><th>Jumlah</th></tr>";
  document.getElementById("tableBody").innerHTML=topRows.map((r,i)=>`
   <tr><td>${getMedalIcon(i+1)}</td><td>${r[namaIdx]||""}</td><td>${r[unitIdx]||""}</td><td>${r[jumlahIdx]||0}</td></tr>
  `).join("");
  const arr=rows.map(r=>parseFloat(r[jumlahIdx])||0).filter(v=>v>0);
  const n=arr.length,sum=arr.reduce((a,b)=>a+b,0);document.getElementById("statPeserta").innerText=n;
  document.getElementById("statRata").innerText=n?(sum/n).toFixed(1):0;
  document.getElementById("statMax").innerText=n?Math.max(...arr):0;
  document.getElementById("statMin").innerText=n?Math.min(...arr):0;

  // POS data
  const posSheet=sheetName==="Rekap"?"PosIndividu":"PosKelompok";
  const posData=await fetchSheet(posSheet);
  if(posData.length>1){
    const posHeaders=posData[0],posRows=posData.slice(1);
    document.getElementById("posSection").style.display="block";
    document.getElementById("posTitle").innerText=sheetName==="Rekap"?"Rekap POS Individu":"Rekap POS Kelompok";
    document.getElementById("posHead").innerHTML="<tr>"+posHeaders.map(h=>`<th>${h}</th>`).join("")+"</tr>";
    document.getElementById("posBody").innerHTML=posRows.map(r=>`<tr>${r.map(c=>`<td>${c||""}</td>`).join("")}</tr>`).join("");
  }else{
    document.getElementById("posSection").style.display="none";
  }

  // per unit
  const map={};rows.forEach(r=>{const u=r[unitIdx],v=parseFloat(r[jumlahIdx])||0;if(!u)return;(map[u]??=[]).push(v);});
  const labels=[],avg=[];document.getElementById("unitBody").innerHTML=Object.entries(map).map(([u,vals])=>{
    const a=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);labels.push(u);avg.push(Number(a));return `<tr><td>${u}</td><td>${a}</td></tr>`;
  }).join("")||"<tr><td colspan='2'>Belum ada data</td></tr>";
  const ctx=document.getElementById("chartUnit").getContext("2d");
  if(chartUnit)chartUnit.destroy();
  chartUnit=new Chart(ctx,{type:"bar",data:{labels,datasets:[{data:avg,backgroundColor:"rgba(37,99,235,0.7)",borderRadius:6}]},
    options:{plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:8}}},y:{beginAtZero:true,max:100}}}});
 }catch(e){console.error(e);}
}

document.getElementById("jenisRekap").addEventListener("change",e=>loadRekap(e.target.value));
loadRekap();
if(refreshTimer)clearInterval(refreshTimer);
refreshTimer=setInterval(()=>{const val=document.getElementById("jenisRekap").value;loadRekap(val);},10000);

// Export
document.getElementById("btnExcel").addEventListener("click",()=>{
 const ws=XLSX.utils.aoa_to_sheet(latestData);const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Rekap");XLSX.writeFile(wb,"Rekap_MPS.xlsx");
});
document.getElementById("btnPDF").addEventListener("click",()=>{
 const {jsPDF}=window.jspdf;const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"});
 doc.text("Rekap Nilai MPS",220,40);doc.autoTable({html:"#rekapTable",startY:60});doc.save("Rekap_MPS.pdf");
});
</script>
<style>
/* ===== Tampilan penuh hanya di mobile ===== */
@media (max-width: 768px) {
  html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    overflow: hidden !important;
    background: #fff !important;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  /* üß≠ Header biru di atas */
  #mobileHeader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100vw;
    height: 50px;
    background: #2563eb;
    color: #fff;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    z-index: 10000;
  }

  /* üè† Tombol Home di kanan header */
  #btnHome {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.3s;
  }
  #btnHome:hover {
    background: rgba(255,255,255,0.4);
  }

  /* üìä Sidebar area */
  .sidebar {
    position: absolute !important;
    right: 0;
    top: 50px;
    width: 300px !important;
    height: calc(100vh - 50px);
    background: #fff !important;
    overflow-y: auto;
    overflow-x: hidden;
    border: none !important;
    box-shadow: none !important;
    transition: width 0.3s ease;
  }

  /* üì± Landscape: sidebar full */
  @media (orientation: landscape) {
    .sidebar {
      width: 100vw !important;
    }
  }

  /* Konten utama penuh layar di bawah header */
  main, .content, .container {
    flex: 1 1 auto;
    width: 100vw;
    max-width: 100vw;
    height: calc(100vh - 50px);
    overflow-y: auto;
    overflow-x: hidden;
    margin: 0 !important;
    padding: 0 !important;
  }
}
</style>

</body>
</html>
